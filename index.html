<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGE-SIGHT: Mission Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-color-critical: rgba(239, 68, 68, 0.7);
            --glow-color-high: rgba(245, 158, 11, 0.7);
            --glow-color-medium: rgba(250, 204, 21, 0.7);
            --glow-color-low: rgba(52, 211, 153, 0.7);
        }

        @keyframes grid-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* slate-950 */
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(34, 197, 94, 0.1) 0%, transparent 50%),
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 50px 50px, 50px 50px;
            animation: grid-pan 60s linear infinite;
        }

        /* --- Animations & Transitions --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse-glow-critical {
            0%, 100% { box-shadow: 0 0 12px 2px var(--glow-color-critical), inset 0 0 15px var(--glow-color-critical); }
            50% { box-shadow: 0 0 24px 8px var(--glow-color-critical), inset 0 0 15px var(--glow-color-critical); }
        }
        @keyframes pulse-glow-high {
            0%, 100% { box-shadow: 0 0 10px 2px var(--glow-color-high), inset 0 0 15px var(--glow-color-high); }
            50% { box-shadow: 0 0 20px 6px var(--glow-color-high), inset 0 0 15px var(--glow-color-high); }
        }
        @keyframes flash-warning-bg {
            0%, 100% { background-color: rgba(250, 204, 21, 0.1); border-color: rgba(250, 204, 21, 0.3); }
            50% { background-color: rgba(250, 204, 21, 0.2); border-color: rgba(250, 204, 21, 0.5); }
        }
        .fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }

        /* --- UI Component Styles --- */
        .main-container { max-width: 95vw; margin: 0 auto; padding: 1.5rem; }
        .primary-btn {
            background: linear-gradient(45deg, #3b82f6, #2563eb); color: white; font-weight: 600;
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: all 0.2s; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .primary-btn:hover { transform: translateY(-2px); box-shadow: 0 7px 20px rgba(59, 130, 246, 0.4); }
        .secondary-btn {
            background-color: #334155; color: #e2e8f0; font-weight: 600;
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.2s;
        }
        .secondary-btn:hover { background-color: #475569; }

        /* --- Hotspot Card Styles --- */
        .hotspot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 2rem;
        }
        .hotspot-card-v2 {
            position: relative; border-radius: 1rem; padding: 1.5rem;
            display: flex; flex-direction: column; justify-content: space-between;
            overflow: hidden; border: 1px solid #334155;
            background: radial-gradient(circle at center, rgba(30, 41, 59, 0.5) 0%, transparent 70%);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .hotspot-card-v2:hover { transform: translateY(-5px); box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); }
        .hotspot-card-v2.severity-critical { animation: pulse-glow-critical 2.5s infinite; border-color: var(--glow-color-critical); }
        .hotspot-card-v2.severity-high { animation: pulse-glow-high 3s infinite; border-color: var(--glow-color-high); }
        .hotspot-card-v2.severity-medium { border-color: var(--glow-color-medium); }
        .hotspot-card-v2.severity-low { border-color: var(--glow-color-low); }
        
        .hotspot-main-content { position: relative; text-align: center; padding: 1rem 0; }
        .hotspot-ntc { font-size: clamp(1.5rem, 5vw, 2.5rem); font-weight: 900; color: #f8fafc; line-height: 1.1; word-break: break-word; }
        .hotspot-total-count { font-size: 1rem; font-weight: 500; color: #94a3b8; }
        .hotspot-etd-display { font-size: 1rem; font-weight: 600; color: #facc15; }
        
        .age-breakdown-table { width: 80%; margin: 1rem auto 0; font-size: 0.875rem; border-collapse: collapse; }
        .age-breakdown-table td { padding: 0.25rem 0.5rem; }
        .age-breakdown-table tr:not(:last-child) td { border-bottom: 1px solid #1e293b; }
        .age-breakdown-label { text-align: left; color: #94a3b8; }
        .age-breakdown-value { text-align: right; font-weight: 700; color: #f8fafc; cursor: pointer; transition: color 0.2s; }
        .age-breakdown-value:hover { color: #60a5fa; }
        
        .hotspot-footer { position: relative; padding-top: 1rem; margin-top: 1rem; border-top: 1px solid #1e293b; }
        .hotspot-pdt-bars { display: flex; flex-direction: column; gap: 0.5rem; }
        .pdt-bar-row { display: flex; align-items: center; gap: 0.75rem; }
        .pdt-bar-label { font-size: 0.8rem; color: #94a3b8; width: 80px; text-align: right; }
        .pdt-bar-container { flex-grow: 1; height: 1.25rem; background-color: #020617; border-radius: 4px; overflow: hidden; display: flex; }
        .pdt-bar-segment { height: 100%; cursor: pointer; transition: filter 0.2s; }
        .pdt-bar-segment:hover { filter: brightness(1.2); }
        .bucket-color-0 { background-color: #38bdf8; }
        .bucket-color-1 { background-color: #34d399; }
        .bucket-color-2 { background-color: #facc15; }
        .bucket-color-3 { background-color: #f87171; }
        .hotspot-actions { margin-top: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }
        .hotspot-action-btn {
            background-color: rgba(30, 41, 59, 0.8); border: 1px solid #334155;
            color: #94a3b8; font-size: 0.875rem; font-weight: 600;
            padding: 0.6rem 1.25rem; border-radius: 99px; transition: all 0.2s; white-space: nowrap;
        }
        .hotspot-action-btn:hover:not(:disabled) { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .hotspot-action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .logic-details { font-size: 0.75rem; color: #64748b; text-align: center; }

        /* --- Modal & Table Styles --- */
        .modal-content { animation: fadeInUp 0.3s ease-out forwards; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #334155; }
        .ntc-suggestion-glow {
            color: #facc15; font-weight: 600; margin-left: 0.5rem;
            animation: glow-animation 1.5s infinite alternate; font-size: 0.8em;
        }

        /* --- System Status HUD --- */
        .status-hud {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            padding: 1.5rem;
            margin-bottom: 3rem;
        }
        .status-item {
            background-color: rgba(15, 23, 42, 0.5);
            border: 1px solid #1e293b;
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
        }
        .status-label {
            font-size: 1rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }
        .status-value {
            font-size: 3rem;
            font-weight: 800;
            color: #f8fafc;
            line-height: 1;
        }
        .status-list {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }
        .status-list li {
            font-size: 1.25rem;
            font-weight: 600;
            padding: 0.5rem 0;
            border-bottom: 1px solid #1e293b;
        }
        .status-list li:last-child {
            border-bottom: none;
        }
        .status-list-rank {
            display: inline-block;
            width: 2rem;
            font-weight: 800;
            color: #64748b;
        }
        .status-value.critical { color: var(--glow-color-critical); }
        
        .recommendation-note {
            padding: 1rem;
            margin-bottom: 2rem;
            border-radius: 0.75rem;
            border: 1px solid;
            text-align: center;
            font-weight: 500;
            color: #fefce8;
            animation: flash-warning-bg 2s infinite;
        }
    </style>
</head>
<body class="text-slate-200">

<div class="main-container">
    <header class="text-center mb-12">
        <h1 class="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-green-400 to-yellow-400">AGE-SIGHT</h1>
        <p class="mt-2 text-2xl text-slate-400 font-light tracking-widest">MISSION CONTROL</p>
    </header>

    <div id="app-content">
        <!-- Initial Upload View -->
        <div id="upload-view" class="max-w-2xl mx-auto text-center fade-in-up">
            <label for="csv-upload" id="upload-label" class="w-full cursor-pointer bg-slate-800/50 hover:bg-slate-700/70 border-2 border-dashed border-slate-600 rounded-lg flex flex-col items-center justify-center p-12 transition-all">
                <svg class="w-16 h-16 text-slate-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25h.375a9 9 0 019 9v.375M10.125 2.25A3.375 3.375 0 0113.5 5.625v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 013.375 3.375M9 15l2.25 2.25L15 12" /></svg>
                <span class="font-semibold text-2xl text-slate-200">Upload Operations File</span>
                <span id="file-name" class="text-base text-slate-400 mt-2">Drag & drop or click to select a .CSV file</span>
            </label>
            <input type="file" id="csv-upload" class="hidden" accept=".csv, text/csv">
            <div id="message-area" class="mt-6 text-center"></div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden space-y-8 fade-in-up">
            <div id="status-hud-container"></div>
            <div id="recommendation-note-container"></div>
            <div class="flex justify-end items-center">
                <label class="flex items-center gap-2 cursor-pointer bg-slate-800/80 p-2 rounded-full text-sm">
                    <span>Urgent Only (ETD < 5h)</span>
                    <div class="toggle-switch relative inline-block w-10 h-6">
                        <input type="checkbox" id="show-urgent-toggle" class="opacity-0 w-0 h-0" checked>
                        <span class="absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-slate-700 rounded-full transition-colors duration-300 before:absolute before:content-[''] before:h-4 before:w-4 before:left-1 before:bottom-1 before:bg-white before:rounded-full before:transition-transform before:duration-300"></span>
                    </div>
                </label>
            </div>
            <div id="summary-panel" class="hotspot-grid"></div>
        </div>
    </div>
    <footer class="text-center text-slate-500 mt-12 border-t border-slate-800 pt-6">
        Designed & Crafted by Rh. | for âš¡ Team Sonic - Hubli (for internal use only)
    </footer>
</div>

<!-- Details Modal -->
<div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
    <div class="modal-content bg-slate-900 p-6 rounded-lg shadow-2xl w-full max-w-6xl border border-slate-700 flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 id="detailsModalTitle" class="text-2xl font-bold text-white">Details</h3>
            <div id="modal-actions" class="flex items-center gap-4"></div>
        </div>
        <div id="detailsModalContent" class="scrollable-pane pr-2" style="max-height: 70vh; overflow-y: auto;"></div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    let fullForecastData = null;
    let modalCurrentData = [];
    let hasPutawayLocation = false;
    let fileTimestamp = null;

    const uploadView = document.getElementById('upload-view');
    const dashboardView = document.getElementById('dashboard-view');
    const csvUpload = document.getElementById('csv-upload');
    const fileNameEl = document.getElementById('file-name');
    const messageArea = document.getElementById('message-area');
    const summaryPanel = document.getElementById('summary-panel');
    const detailsModal = document.getElementById('detailsModal');
    const detailsModalTitle = document.getElementById('detailsModalTitle');
    const detailsModalContent = document.getElementById('detailsModalContent');
    const modalActions = document.getElementById('modal-actions');
    
    const urgentToggleInput = document.getElementById('show-urgent-toggle');
    if (urgentToggleInput) {
        urgentToggleInput.addEventListener('change', () => {
            const slider = urgentToggleInput.nextElementSibling;
            if (urgentToggleInput.checked) {
                slider.classList.add('bg-blue-600');
                slider.classList.remove('bg-slate-700');
                slider.classList.add('before:translate-x-4');
            } else {
                slider.classList.remove('bg-blue-600');
                slider.classList.add('bg-slate-700');
                slider.classList.remove('before:translate-x-4');
            }
        });
        urgentToggleInput.dispatchEvent(new Event('change'));
    }

    csvUpload.addEventListener('change', (e) => handleFileUpload(e.target.files));
    
    dashboardView.addEventListener('click', (e) => {
        const ageValue = e.target.closest('.age-breakdown-value');
        if (ageValue) {
            const { ntc, bucket } = ageValue.dataset;
            const filtered = fullForecastData.filter(r => r.ntc === ntc && r.age_bucket === bucket);
            openDetailsModal(`Details for ${ntc} > ${bucket}`, filtered, false);
        }

        const cutoffBtn = e.target.closest('.hotspot-action-btn');
        if (cutoffBtn) {
            const { ntc, pdt, cutoff } = cutoffBtn.dataset;
            if (!cutoff || cutoff === 'null') return; 

            const pdtsToFilter = pdt.split(',');
            const filteredData = fullForecastData.filter(r => 
                r.ntc === ntc &&
                pdtsToFilter.includes(r.pdt) &&
                r.age_hours >= parseFloat(cutoff)
            );

            const modalTitle = `Recommended Ageing List for ${ntc} (${pdt})`;
            openDetailsModal(modalTitle, filteredData, true);
        }
    });

    dashboardView.addEventListener('change', (e) => {
        if (e.target.id === 'show-urgent-toggle') {
            renderSummaryPanel();
        }
    });

    modalActions.addEventListener('click', e => {
        const target = e.target.closest('button');
        if (!target) return;
        if (target.id === 'closeDetailsModal') closeAllModals();
        if (target.id === 'copyForChatBtn') copyModalChatData(target);
        if (target.id === 'recommendPickSpacesBtn') showPickSpaces();
        if (target.id === 'backToDetailsBtn') renderTable(modalCurrentData, null, true);
        if (target.id === 'copyLocationsBtn') copyPickLocations(target);
    });
    detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) closeAllModals(); });

    function handleFileUpload(files) {
        const file = files[0];
        if (!file) return;
        fileTimestamp = file.lastModifiedDate;
        fileNameEl.textContent = file.name;
        const reader = new FileReader();
        reader.onload = (event) => processCsvData(event.target.result);
        reader.onerror = () => showMessage("Error reading file.", true);
        reader.readAsText(file);
    }

    function parseCsvLine(line) {
        const results = [];
        const regex = /(?:^|,)(\"(?:[^\"]+|\"\")*\"|[^,]*)/g;
        let match;
        while (match = regex.exec(line)) {
            let value = match[1];
            if (value.startsWith('"') && value.endsWith('"')) {
                value = value.slice(1, -1).replace(/""/g, '"');
            }
            results.push(value.trim());
        }
        return results;
    }

    function processCsvData(csvString) {
        showMessage('Processing...', false);
        try {
            const lines = csvString.trim().split('\n');
            const headerLine = lines[0].trim();
            const rawHeaders = parseCsvLine(headerLine);
            const headers = rawHeaders.map(h => h.replace(/\s+/g, '_').toLowerCase());
            
            const requiredHeaders = ['bag_id', 'incoming_time', 'pdt', 'bag_status', 'is_lock', 'ntc_used'];
            if (!requiredHeaders.every(h => headers.includes(h))) {
                throw new Error(`Missing required columns: ${requiredHeaders.filter(h => !headers.includes(h)).join(', ')}`);
            }
            
            hasPutawayLocation = headers.includes('putaway_location');
            const data = lines.slice(1).map(line => {
                const values = parseCsvLine(line.trim());
                const obj = {};
                headers.forEach((header, i) => { obj[header] = values[i] || ''; });
                return obj;
            });

            const totalRows = data.length;
            const inCenterRows = data.filter(r => r.bag_status && r.bag_status.toLowerCase() === 'in_center').length;
            fullForecastData = analyzeAndEnrichData(data);
            const summaryMessage = `<div class="text-left bg-slate-800/50 p-4 rounded-lg border border-slate-700 max-w-md mx-auto"><h4 class="font-bold text-lg text-blue-300 mb-2">File Scan Results:</h4><p>Total Records Found: <b class="text-white">${totalRows}</b></p><p>Records "In Center": <b class="text-white">${inCenterRows}</b></p><p class="mt-2 pt-2 border-t border-slate-700">Actionable Shipments Found: <b class="text-green-400 text-xl">${fullForecastData.length}</b></p></div>`;
            showMessage(summaryMessage, false);

            setTimeout(() => {
                setupDashboard();
            }, 1500);

        } catch (error) {
            showMessage(`An error occurred: ${error.message}`, true);
        }
    }

    function analyzeAndEnrichData(data) {
        const now = new Date();
        return data
            .filter(row => row.bag_status && row.is_lock && row.bag_status.toLowerCase() === 'in_center' && row.is_lock.toUpperCase() === 'FALSE')
            .map(row => {
                const incomingDate = new Date(row.incoming_time.replace(' ', 'T'));
                if (isNaN(incomingDate.getTime())) return null;
                const age_hours = Math.max(0, (now - incomingDate) / (1000 * 60 * 60));
                let age_bucket;
                if (age_hours < 24) age_bucket = '0 Day';
                else if (age_hours < 48) age_bucket = '1 Day';
                else if (age_hours < 96) age_bucket = '2-4 Days';
                else age_bucket = 'Above 4 Days';
                const ntcUsed = row.ntc_used || 'Unknown';
                const ntcSuggested = row.ntc_suggested_by_cluster || 'Unknown';
                return { 
                    ...row, 
                    age_hours: parseFloat(age_hours.toFixed(2)), 
                    age_bucket,
                    ntc: ntcUsed,
                    ntc_suggested: ntcSuggested,
                    ntc_mismatch: ntcUsed !== 'Unknown' && ntcSuggested !== 'Unknown' && ntcUsed !== ntcSuggested,
                };
            })
            .filter(Boolean);
    }
    
    function setupDashboard() {
        uploadView.classList.add('hidden');
        dashboardView.classList.remove('hidden');
        renderSummaryPanel();
    }
    
    function calculateCutoff(shipments) {
        const now = new Date();
        const relevantShipments = shipments.filter(r => r.etd && new Date(r.etd.replace(' ', 'T')) > now);
        if (relevantShipments.length === 0) return { cutoff: null, nextETD: null };
        const nextETD = new Date(Math.min(...relevantShipments.map(r => new Date(r.etd.replace(' ', 'T')))));
        const timeUntilNextETD_hours = (nextETD - now) / (1000 * 60 * 60);
        const cutoffFor24hSLA = 24 - timeUntilNextETD_hours;
        return {
            cutoff: cutoffFor24hSLA > 0 ? cutoffFor24hSLA.toFixed(1) : null,
            nextETD: nextETD
        };
    }

    function getSummaryData() {
        const summary = fullForecastData.reduce((acc, row) => {
            const { ntc, pdt, etd } = row;
            if (!acc[ntc]) {
                acc[ntc] = { total: 0, b2c_heavy: { '0 Day': 0, '1 Day': 0, '2-4 Days': 0, 'Above 4 Days': 0, total: 0 }, b2b: { '0 Day': 0, '1 Day': 0, '2-4 Days': 0, 'Above 4 Days': 0, total: 0 }, soonestETD: null };
            }
            const pdtGroup = (pdt === 'B2B') ? 'b2b' : 'b2c_heavy';
            acc[ntc][pdtGroup][row.age_bucket]++;
            acc[ntc][pdtGroup].total++;
            acc[ntc].total++;
            if (etd) {
                const etdDate = new Date(etd.replace(' ', 'T'));
                if (!isNaN(etdDate) && etdDate > new Date() && (!acc[ntc].soonestETD || etdDate < acc[ntc].soonestETD)) {
                    acc[ntc].soonestETD = etdDate;
                }
            }
            return acc;
        }, {});

        return Object.entries(summary).map(([ntc, data]) => {
            const ntcShipments = fullForecastData.filter(r => r.ntc === ntc);
            const b2cHeavyShipments = ntcShipments.filter(r => r.pdt !== 'B2B');
            const b2bShipments = ntcShipments.filter(r => r.pdt === 'B2B');
            const severeCount = data.b2c_heavy['2-4 Days'] + data.b2c_heavy['Above 4 Days'] + data.b2b['2-4 Days'] + data.b2b['Above 4 Days'];
            const severityScore = (data.b2c_heavy['1 Day'] + data.b2b['1 Day']) * 1 + (data.b2c_heavy['2-4 Days'] + data.b2b['2-4 Days']) * 3 + (data.b2c_heavy['Above 4 Days'] + data.b2b['Above 4 Days']) * 5;
            let severityLevel = 'low';
            if (severityScore > data.total * 0.5) severityLevel = 'medium';
            if (severityScore > data.total) severityLevel = 'high';
            if (severeCount > 20 && (severeCount / data.total) > 0.3) severityLevel = 'critical';
            return { ntc, data, severityScore, severityLevel, b2c_heavy_recommendation: calculateCutoff(b2cHeavyShipments), b2b_recommendation: calculateCutoff(b2bShipments) };
        });
    }

    function renderSummaryPanel() {
        if (!fullForecastData || fullForecastData.length === 0) {
            summaryPanel.innerHTML = `<div class="col-span-full text-center bg-slate-800/50 p-8 rounded-lg border border-slate-700"><h3 class="font-bold text-2xl text-yellow-400 mb-2">No Actionable Data Found</h3><p class="text-slate-400">The uploaded file does not contain any shipments that are currently <b class="text-white">"in_center"</b> and have an <b class="text-white">"is_lock"</b> status of <b class="text-white">"FALSE"</b>.</p><p class="text-slate-500 mt-2">Please upload a file with current operational data to activate the dashboard.</p></div>`;
            document.getElementById('status-hud-container').innerHTML = '';
            document.getElementById('recommendation-note-container').innerHTML = '';
            return;
        }

        const toggle = document.getElementById('show-urgent-toggle');
        const showUrgentOnly = toggle ? toggle.checked : false;
        let summaryData = getSummaryData();
        
        renderHUD(summaryData);
        renderRecommendationNote();

        if (showUrgentOnly) {
            const fiveHoursFromNow = new Date().getTime() + (5 * 60 * 60 * 1000);
            summaryData = summaryData.filter(item => item.data.soonestETD && item.data.soonestETD.getTime() < fiveHoursFromNow);
        }
        summaryData.sort((a, b) => b.severityScore - a.severityScore);
        if (summaryData.length === 0) {
            summaryPanel.innerHTML = `<p class="text-slate-400 text-center col-span-full">No NTCs match the current "Urgent Only" view.</p>`;
            return;
        }
        summaryPanel.innerHTML = summaryData.map(({ ntc, data, severityLevel, b2c_heavy_recommendation, b2b_recommendation }) => {
            const ageBuckets = ['0 Day', '1 Day', '2-4 Days', 'Above 4 Days'];
            const totalAgeData = ageBuckets.map(bucket => ({
                label: bucket,
                count: (data.b2c_heavy[bucket] || 0) + (data.b2b[bucket] || 0)
            }));
            const b2cHeavyBar = ageBuckets.map((bucket, i) => {
                const count = data.b2c_heavy[bucket];
                if (count === 0) return '';
                const percentage = data.b2c_heavy.total > 0 ? (count / data.b2c_heavy.total) * 100 : 0;
                return `<div class="pdt-bar-segment bucket-color-${i}" style="width: ${percentage}%" data-ntc="${ntc}" data-pdt="B2C,Heavy" data-bucket="${bucket}" title="${bucket}: ${count}"></div>`;
            }).join('');
            const b2bBar = ageBuckets.map((bucket, i) => {
                const count = data.b2b[bucket];
                if (count === 0) return '';
                const percentage = data.b2b.total > 0 ? (count / data.b2b.total) * 100 : 0;
                return `<div class="pdt-bar-segment bucket-color-${i}" style="width: ${percentage}%" data-ntc="${ntc}" data-pdt="B2B" data-bucket="${bucket}" title="${bucket}: ${count}"></div>`;
            }).join('');
            const etdString = data.soonestETD ? `ETD in ${getCountdownString(data.soonestETD)}` : 'No Upcoming ETD';
            
            const b2cCutoff = b2c_heavy_recommendation.cutoff;
            const b2bCutoff = b2b_recommendation.cutoff;

            return `
                <div class="hotspot-card-v2 severity-${severityLevel}">
                    <div class="hotspot-main-content">
                        <div class="hotspot-ntc">${ntc}</div>
                        <div class="hotspot-total-count">${data.total} Shipments</div>
                        <div class="hotspot-etd-display">${etdString}</div>
                        <table class="age-breakdown-table">
                            <tbody>
                                ${totalAgeData.map(age => `<tr><td class="age-breakdown-label">${age.label}</td><td class="age-breakdown-value" data-ntc="${ntc}" data-bucket="${age.label}">${age.count}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="hotspot-footer">
                        <div class="hotspot-pdt-bars">
                            <div class="pdt-bar-row"><span class="pdt-bar-label">B2C/Heavy</span><div class="pdt-bar-container">${b2cHeavyBar}</div></div>
                            <div class="pdt-bar-row"><span class="pdt-bar-label">B2B</span><div class="pdt-bar-container">${b2bBar}</div></div>
                        </div>
                        <div class="hotspot-actions">
                            <div class="flex flex-col items-center">
                                <button class="hotspot-action-btn" data-ntc="${ntc}" data-pdt="B2C,Heavy" data-cutoff="${b2cCutoff}" ${!b2cCutoff ? 'disabled' : ''}>Recommended B2C/H Ageing List</button>
                                ${b2cCutoff ? `<div class="logic-details">Cut-off: ${b2cCutoff}h | Next ETD: ${b2c_heavy_recommendation.nextETD.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>` : ''}
                            </div>
                            <div class="flex flex-col items-center">
                                <button class="hotspot-action-btn" data-ntc="${ntc}" data-pdt="B2B" data-cutoff="${b2bCutoff}" ${!b2bCutoff ? 'disabled' : ''}>Recommended B2B Ageing List</button>
                                ${b2bCutoff ? `<div class="logic-details">Cut-off: ${b2bCutoff}h | Next ETD: ${b2b_recommendation.nextETD.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
        }).join('');
    }
    
    function renderHUD(summaryData) {
        const container = document.getElementById('status-hud-container');
        const totalShipments = fullForecastData.length;
        const topCritical = summaryData.sort((a,b) => b.severityScore - a.severityScore).slice(0, 3);
        const fileDate = fileTimestamp ? fileTimestamp.toLocaleString() : 'N/A';
        
        let fileAgeWarning = '';
        if (fileTimestamp) {
            const fileAgeHours = (new Date() - fileTimestamp) / 3600000; // ms to hours
            if (fileAgeHours > 1) {
                fileAgeWarning = `<div class="status-label mt-1 text-yellow-400 font-bold">Warning: File is ${fileAgeHours.toFixed(1)} hours old</div>`;
            }
        }

        container.innerHTML = `
            <div class="status-hud">
                <div class="status-item">
                    <div class="status-label">Total Actionable Shipments</div>
                    <div class="status-value">${totalShipments}</div>
                    <div class="status-label mt-2">File Time: ${fileDate}</div>
                    ${fileAgeWarning}
                </div>
                <div class="status-item">
                    <div class="status-label">Top Critical NTC's</div>
                    <ul class="status-list">
                        ${topCritical.length > 0 ? topCritical.map((item, index) => `<li><span class="status-list-rank">#${index + 1}</span> ${item.ntc}</li>`).join('') : '<li>No critical hotspots</li>'}
                    </ul>
                </div>
            </div>
        `;
    }

    function renderRecommendationNote() {
        document.getElementById('recommendation-note-container').innerHTML = `
            <div class="recommendation-note">
                <b>Note:</b> Recommended age cut-off is based on the next available ETD and assumes only one connection exists in 24 hours.
            </div>
        `;
    }

    function getCountdownString(etdDate) {
        const diff = new Date(etdDate) - new Date();
        if (diff <= 0) return 'Departed';
        const hours = Math.floor(diff / (3600000));
        const minutes = Math.floor((diff % 3600000) / 60000);
        return `${String(hours).padStart(2,'0')}h ${String(minutes).padStart(2,'0')}m`;
    }

    function renderTable(data, container, isSuggestion) {
        modalCurrentData = data;
        setupModalActions('table', isSuggestion);
        if (data.length === 0) {
            detailsModalContent.innerHTML = `<p class="text-slate-400 p-8 text-center">No shipments match.</p>`;
            return;
        }
        const table = document.createElement('table');
        table.className = 'data-table';
        table.innerHTML = `
            <thead><tr>
                <th>Bag ID</th><th>Age (Hrs)</th>${hasPutawayLocation ? '<th>Location</th>' : ''}<th>PDT</th><th>Priority</th><th>NTC</th><th>Client</th>
            </tr></thead>
            <tbody>
            ${data.map(wbn => `
                <tr>
                    <td><a href="#" class="text-blue-400 hover:underline">${wbn.bag_id}</a></td>
                    <td class="${wbn.age_hours >= 48 ? 'text-red-400 font-bold' : ''}">${wbn.age_hours}</td>
                    ${hasPutawayLocation ? `<td>${wbn.putaway_location || 'N/A'}</td>` : ''}
                    <td>${wbn.pdt}</td>
                    <td>${wbn.priority}</td>
                    <td>${wbn.ntc}${wbn.ntc_mismatch ? `<span class="ntc-suggestion-glow" title="Suggested: ${wbn.ntc_suggested}">*${wbn.ntc_suggested}</span>` : ''}</td>
                    <td class="truncate" title="${wbn.client}">${wbn.client}</td>
                </tr>
            `).join('')}
            </tbody>`;
        detailsModalContent.innerHTML = '';
        detailsModalContent.appendChild(table);
    }
    
    function openDetailsModal(title, data, isSuggestion) {
        modalCurrentData = data;
        detailsModalTitle.textContent = title;
        renderTable(data, detailsModalContent, isSuggestion);
        detailsModal.classList.remove('hidden');
        detailsModal.classList.add('flex');
    }

    function showPickSpaces() {
        const locations = [...new Set(modalCurrentData.map(item => item.putaway_location).filter(Boolean))];
        setupModalActions('locations');
        if (locations.length === 0) {
            detailsModalContent.innerHTML = `<p class="text-slate-400 p-8 text-center">No putaway locations found.</p>`;
            return;
        }
        detailsModalContent.innerHTML = `<div class="flex flex-wrap gap-3 p-4">${locations.sort().map(loc => `<span class="bg-slate-700 text-slate-200 font-mono text-lg py-2 px-4 rounded-md">${loc}</span>`).join('')}</div>`;
    }

    function setupModalActions(view, isSuggestion = false) {
        let buttonsHTML = '';
        if (view === 'table') {
            buttonsHTML += `<button id="copyForChatBtn" class="secondary-btn">Copy for Chat</button>`;
            if (isSuggestion && hasPutawayLocation) {
                buttonsHTML += `<button id="recommendPickSpacesBtn" class="primary-btn" style="background: linear-gradient(45deg, #f59e0b, #facc15);">Recommend Pick Spaces</button>`;
            }
        } else if (view === 'locations') {
            buttonsHTML += `<button id="backToDetailsBtn" class="secondary-btn">Back to Details</button><button id="copyLocationsBtn" class="primary-btn">Copy Locations</button>`;
        }
        buttonsHTML += `<button id="closeDetailsModal" class="text-slate-400 hover:text-white ml-4"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
        modalActions.innerHTML = buttonsHTML;
    }

    function closeAllModals() {
        detailsModal.classList.add('hidden');
        detailsModal.classList.remove('flex');
        modalCurrentData = [];
    }
    
    function copyToClipboard(data, button) {
        navigator.clipboard.writeText(data).then(() => {
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            setTimeout(() => { button.textContent = originalText; }, 2000);
        }).catch(err => console.error('Failed to copy: ', err));
    }

    function copyModalChatData(button) {
        const table = detailsModalContent.querySelector('table');
        if (!table) return;
        const rows = [...table.querySelectorAll('tbody tr')];
        const ntcIndex = hasPutawayLocation ? 5 : 4;
        const bagIdIndex = 0;
        const groupedByNtc = rows.reduce((acc, row) => {
            const ntc = row.cells[ntcIndex].textContent.trim().split('*')[0];
            const bagId = row.cells[bagIdIndex].textContent.trim();
            (acc[ntc] = acc[ntc] || []).push(bagId);
            return acc;
        }, {});
        let chatString = Object.entries(groupedByNtc).map(([ntc, bags]) => `${ntc}\n${bags.join('\n')}`).join('\n\n');
        copyToClipboard(chatString.trim(), button);
    }
    
    function copyPickLocations(button) {
        const locations = [...detailsModalContent.querySelectorAll('span')].map(span => span.textContent.trim());
        if (locations.length > 0) copyToClipboard(locations.join('\n'), button);
    }

    function showMessage(msg, isError) {
        const messageArea = document.getElementById('message-area');
        messageArea.innerHTML = msg;
        if (isError) {
            messageArea.className = `mt-4 text-center p-3 rounded-md text-red-200 bg-red-900/40`;
        } else {
            messageArea.className = `mt-4 text-center`;
        }
    }
});
</script>

</body>
</html>
