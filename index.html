<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGE-SIGHT: Mission Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --glow-color-critical: rgba(239, 68, 68, 0.7);
            --glow-color-high: rgba(245, 158, 11, 0.7);
            --glow-color-medium: rgba(52, 211, 153, 0.5); /* Adjusted for subtler hover */
            --glow-color-clear: rgba(34, 197, 94, 0.6);
        }

        @keyframes grid-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* slate-950 */
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(59, 130, 246, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 75% 75%, rgba(34, 197, 94, 0.05) 0%, transparent 40%),
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
            animation: grid-pan 80s linear infinite;
        }

        /* --- Lite Mode: Performance Optimization --- */
        .lite-mode-active * {
            transition: none !important;
            animation: none !important;
        }

        /* --- NEW: Lite Mode Banner Style (when OFF) --- */
        #lite-mode-toggle:not(.active) {
            background-color: #f59e0b !important;
            color: #000 !important;
            font-weight: 700 !important;
            border-color: #facc15 !important;
        }
        #lite-mode-toggle:not(.active):hover {
            background-color: #facc15 !important;
        }

        /* --- NEW: LITE MODE OVERRIDES --- */
        .lite-mode-active {
            background: #000000 !important;
            color: #eeeeee !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
        }

        .lite-mode-active * {
            /* --- CRITICAL EXCLUSIONS --- */
            transition: none !important;
            animation: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            backdrop-filter: none !important;
            background-image: none !important;
            text-shadow: none !important;
        }
        
        /* --- General Typography --- */
        .lite-mode-active body, .lite-mode-active .main-container, .lite-mode-active p {
             background: #000000 !important;
             color: #eeeeee !important;
             font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
        }
        .lite-mode-active h1, .lite-mode-active h2, .lite-mode-active h3, .lite-mode-active h4, .lite-mode-active h5, .lite-mode-active h6 {
            color: #eeeeee !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
        }
        .lite-mode-active h1 { /* Header override */
            background: none !important;
            color: #eeeeee !important;
            -webkit-text-fill-color: #eeeeee !important;
        }
        .lite-mode-active a, .lite-mode-active .update-log-link {
            color: #9e9eff !important;
            text-decoration: underline !important;
        }
        .lite-mode-active span, .lite-mode-active div {
             color: inherit; /* Inherit #eee from parent */
        }
        /* Fix text colors that are set explicitly */
        .lite-mode-active .text-slate-200, .lite-mode-active .text-slate-300, .lite-mode-active .text-slate-400, .lite-mode-active .text-slate-500, .lite-mode-active .text-white, .lite-mode-active .text-f1f5f9, .lite-mode-active .text-f8fafc, .lite-mode-active .text-e2e8f0, .lite-mode-active .text-cbd5e1, .lite-mode-active .text-94a3b8, .lite-mode-active .text-64748b, .lite-mode-active .mode-subtitle {
            color: #eeeeee !important;
        }
        .lite-mode-active .text-yellow-400, .lite-mode-active .text-facc15, .lite-mode-active .text-fde047, .lite-mode-active .text-yellow-300, .lite-mode-active .hotspot-etd-display, .lite-mode-active .clickable-count { color: #ffffa0 !important; }
        .lite-mode-active .text-red-400, .lite-mode-active .text-f87171, .lite-mode-active .text-ef4444 { color: #ff8080 !important; }
        .lite-mode-active .text-green-400, .lite-mode-active .text-4ade80, .lite-mode-active .text-22c55e, .lite-mode-active .text-green-600 { color: #80ff80 !important; }
        .lite-mode-active .text-blue-400, .lite-mode-active .text-60a5fa, .lite-mode-active .text-3b82f6, .lite-mode-active .text-blue-300 { color: #9e9eff !important; }


        /* --- Layout: Force single column --- */
        .lite-mode-active .hotspot-grid,
        .lite-mode-active .review-grid {
            display: block !important;
        }
        .lite-mode-active .hotspot-card-v2,
        .lite-mode-active .review-card {
            margin-bottom: 1rem; /* Add spacing since grid-gap is gone */
        }
        /* Force block on most flex containers */
        .lite-mode-active .flex { display: block !important; }
        .lite-mode-active .flex-wrap { flex-wrap: nowrap !important; }
        .lite-mode-active .flex-row { flex-direction: column !important; }
        .lite-mode-active .justify-between { justify-content: flex-start !important; }
        .lite-mode-active .items-center { align-items: flex-start !important; }
        .lite-mode-active .items-end { align-items: flex-start !important; }
        
        /* Keep *some* flex for simple component layouts */
        .lite-mode-active .mode-selector,
        .lite-mode-active .status-btn-group,
        .lite-mode-active .remarks-tags,
        .lite-mode-active .report-filter-group,
        .lite-mode-active .quick-stats,
        .lite-mode-active .hotspot-actions {
             display: flex !important;
             flex-direction: row !important;
        }
        .lite-mode-active .quick-stat-item { text-align: left !important; }
        .lite-mode-active .hotspot-actions { justify-content: flex-start !important; }


        /* --- Borders & Backgrounds --- */
        .lite-mode-active .main-container,
        .lite-mode-active .hotspot-card-v2,
        .lite-mode-active .review-card,
        .lite-mode-active .modal-content,
        .lite-mode-active .data-table,
        .lite-mode-active .critical-summary-panel,
        .lite-mode-active .mode-alert,
        .lite-mode-active .upload-label,
        .lite-mode-active .review-list-info,
        .lite-mode-active .quick-stats,
        .lite-mode-active .card-alert {
            background: #000000 !important;
            border: 1px solid #555555 !important;
        }
        /* Specific background overrides */
        .lite-mode-active .hotspot-card-v2.severity-critical,
        .lite-mode-active .hotspot-card-v2.severity-high,
        .lite-mode-active .review-card.is-complete {
             background: #000000 !important;
             border: 1px solid #555555 !important;
        }
        .lite-mode-active .hotspot-card-v2.severity-critical { border-color: #ff8080 !important; }
        .lite-mode-active .hotspot-card-v2.severity-high { border-color: #ffffa0 !important; }
        .lite-mode-active .review-card.is-complete { border-color: #80ff80 !important; }

        .lite-mode-active .bg-slate-800, .lite-mode-active .bg-slate-900, .lite-mode-active .bg-slate-800\/50, .lite-mode-active .bg-slate-700\/70,
        .lite-mode-active .bg-slate-900\/60, .lite-mode-active .bg-black, .lite-mode-active .bg-slate-950, .lite-mode-active .bg-0f172a, .lite-mode-active .bg-1e293b, .lite-mode-active .bg-334155,
        .lite-mode-active .bg-slate-700, .lite-mode-active .bg-blue-600, .lite-mode-active .bg-opacity-75 {
            background: #000 !important;
            background-color: #000 !important;
        }


        /* --- Buttons --- */
        .lite-mode-active button,
        .lite-mode-active .primary-btn,
        .lite-mode-active .secondary-action-btn,
        .lite-mode-active .lite-mode-btn,
        .lite-mode-active .hotspot-action-btn,
        .lite-mode-active .review-action-btn,
        .lite-mode-active .mode-btn,
        .lite-mode-active .ntc-report-btn,
        .lite-mode-active .status-btn-group button,
        .lite-mode-active .report-filter-btn,
        .lite-mode-active .toggle-summary-btn {
            background: #222222 !important;
            color: #eeeeee !important;
            border: 1px solid #777777 !important;
            padding: 0.5em 1em !important;
            transform: none !important;
        }
        .lite-mode-active button:hover:not(:disabled),
        .lite-mode-active .primary-btn:hover:not(:disabled),
        .lite-mode-active .secondary-action-btn:hover:not(:disabled),
        .lite-mode-active .lite-mode-btn:hover:not(:disabled),
        .lite-mode-active .hotspot-action-btn:hover:not(:disabled),
        .lite-mode-active .review-action-btn:hover:not(:disabled),
        .lite-mode-active .mode-btn:hover:not(:disabled),
        .lite-mode-active .ntc-report-btn:hover:not(:disabled),
        .lite-mode-active .status-btn-group button:hover:not(:disabled),
        .lite-mode-active .report-filter-btn:hover:not(:disabled),
        .lite-mode-active .toggle-summary-btn:hover:not(:disabled) {
            background: #444444 !important;
        }
        /* Active/Selected State */
        .lite-mode-active .lite-mode-btn.active,
        .lite-mode-active .mode-btn.active,
        .lite-mode-active .status-btn-group button.active-connected,
        .lite-mode-active .status-btn-group button.active-not-connected,
        .lite-mode-active .report-filter-btn.active {
            background: #444444 !important;
            font-weight: bold !important;
        }
        /* Special Button States */
        .lite-mode-active .hotspot-action-btn.is-clear,
        .lite-mode-active .review-card.is-complete .review-action-btn {
            background: #222 !important;
            border-color: #80ff80 !important;
            color: #80ff80 !important;
        }
         .lite-mode-active button:disabled,
         .lite-mode-active .primary-btn:disabled,
         .lite-mode-active .hotspot-action-btn:disabled,
         .lite-mode-active .review-action-btn:disabled {
             background: #111 !important;
             color: #555 !important;
             border-color: #555 !important;
             opacity: 1 !important;
         }

        /* --- Inputs --- */
        .lite-mode-active input[type="password"],
        .lite-mode-active input[type="text"],
        .lite-mode-active .report-textarea,
        .lite-mode-active .remarks-textarea {
            background: #111111 !important;
            color: #eeeeee !important;
            border: 1px solid #777777 !important;
        }

        /* --- Form Elements (Toggles) --- */
        .lite-mode-active .toggle-switch {
            width: auto !important;
            height: auto !important;
            background: none !important;
            position: static !important;
        }
        .lite-mode-active .toggle-switch span { /* Hide custom slider */
            display: none !important;
        }
        .lite-mode-active .toggle-switch input[type="checkbox"] {
            opacity: 1 !important;
            width: auto !important;
            height: auto !important;
            position: static !important;
            /* Use browser default styles */
            -webkit-appearance: checkbox !important;
            -moz-appearance: checkbox !important;
            appearance: checkbox !important; 
            margin-left: 5px !important;
        }
        .lite-mode-active label {
            display: flex !important;
            align-items: center !important;
        }

        /* --- Icons --- */
        .lite-mode-active svg {
            display: none !important; /* Hide all SVGs */
        }
        /* Add text replacements */
        .lite-mode-active .ntc-report-btn::after { content: "[Report]"; }
        .lite-mode-active #closeUpdateLogModal::after,
        .lite-mode-active #closeDetailsModal::after { content: "[Close]"; padding: 0.5em 1em; }
        .lite-mode-active .card-alert-title::before { content: "[!]"; margin-right: 0.5em; font-weight: bold; }
        .lite-mode-active .panel-header .toggle-icon::after { content: "[v]"; }
        .lite-mode-active .panel-header .toggle-icon.rotate-180::after { content: "[^]"; }
        .lite-mode-active #bulkSearchBtn::after { content: " [v]"; }
        .lite-mode-active .all-clear-message::before { content: "[OK]"; font-size: 2rem; color: #80ff80; }
        
        /* --- Misc --- */
        .lite-mode-active .review-progress-bar-bg { background: #555 !important; }
        .lite-mode-active .review-progress-bar { background: #80ff80 !important; }
        .lite-mode-active .age-stat { border-color: #555 !important; }
        .lite-mode-active .hotspot-footer { border-color: #555 !important; }
        .lite-mode-active .quick-stats { border-color: #555 !important; }
        .lite-mode-active .review-card-header { border-color: #555 !important; }
        .lite-mode-active footer { border-color: #555 !important; }
        .lite-mode-active .data-table th, .lite-mode-active .data-table td { border-color: #555 !important; }
        .lite-mode-active .critical-summary-panel .summary-table th,
        .lite-mode-active .critical-summary-panel .summary-table td { border-color: #555 !important; }
        .lite-mode-active .critical-summary-panel .panel-content { border-color: #ff8080 !important; }
        /* --- END LITE MODE OVERRIDES --- */


        /* --- Animations & Transitions --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse-glow-critical {
            0%, 100% { box-shadow: 0 0 10px 0px var(--glow-color-critical), inset 0 0 10px var(--glow-color-critical); }
            50% { box-shadow: 0 0 20px 5px var(--glow-color-critical), inset 0 0 10px var(--glow-color-critical); }
        }
        @keyframes pulse-glow-high {
            0%, 100% { box-shadow: 0 0 8px 0px var(--glow-color-high), inset 0 0 8px var(--glow-color-high); }
            50% { box-shadow: 0 0 16px 4px var(--glow-color-high), inset 0 0 8px var(--glow-color-high); }
        }
        .fade-in-up { animation: fadeInUp 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }

        /* --- General UI --- */
        .main-container { max-width: 95vw; margin: 0 auto; padding: 1.5rem; }
        .primary-btn {
            background: linear-gradient(45deg, #3b82f6, #2563eb); color: white; font-weight: 600;
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: all 0.2s; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
       .primary-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4); }
       .primary-btn:disabled { background: #334155; box-shadow: none; cursor: not-allowed; opacity: 0.6; }
       .secondary-action-btn {
            background-color: #334155;
            color: #e2e8f0;
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid #475569;
        }
        .secondary-action-btn:hover {
            background-color: #475569;
            color: white;
        }

        /* --- Live Mode: Hotspot Card Styles --- */
        .hotspot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1.5rem;
        }
        .hotspot-card-v2 {
            position: relative; border-radius: 1rem; padding: 1.25rem;
            display: flex; flex-direction: column; justify-content: space-between;
            overflow: hidden; border: 1px solid #334155;
            background: rgba(30, 41, 59, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .hotspot-card-v2:hover { 
            transform: translateY(-5px) scale(1.02); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-color: var(--glow-color-medium);
        }
        .hotspot-card-v2.severity-critical { animation: pulse-glow-critical 3s infinite ease-in-out; border-color: var(--glow-color-critical); }
        .hotspot-card-v2.severity-high { animation: pulse-glow-high 3.5s infinite ease-in-out; border-color: var(--glow-color-high); }
        
        .hotspot-header { text-align: center; }
        .hotspot-ntc { font-size: clamp(1.4rem, 4vw, 2rem); font-weight: 900; color: #f8fafc; line-height: 1.1; word-break: break-word; }
        .hotspot-total-count { font-size: 0.9rem; font-weight: 500; color: #94a3b8; }
        .hotspot-etd-display { font-size: 1rem; font-weight: 600; color: #facc15; }
        
        .card-alert {
            background-color: rgba(251, 191, 36, 0.08); border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 0.75rem; padding: 0.75rem 1rem; margin: 1rem 0; text-align: left;
        }
        .card-alert-title {
            font-weight: 700; color: #facc15; display: flex; align-items: center;
            gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.9rem;
        }
        .card-alert-message { font-size: 0.85rem; color: #e2e8f0; line-height: 1.5; }
        .clickable-count {
            font-weight: 900; color: #fde047; cursor: pointer; text-decoration: underline;
            text-decoration-style: dotted; text-underline-offset: 3px; transition: color 0.2s;
        }
        .clickable-count:hover { color: #f59e0b; }
        .age-stats-container { display: flex; flex-direction: column; gap: 0.5rem; padding: 0 1rem; }
        .age-stat {
            display: flex; justify-content: space-between; align-items: baseline;
            font-size: 0.9rem; padding: 0.2rem 0; border-bottom: 1px solid #1e293b;
        }
        .age-stat:last-child { border-bottom: none; }
        .age-stat-label { color: #94a3b8; }
        .age-stat-value {
            font-weight: 700; font-size: 1.1rem; color: #f8fafc;
            cursor: pointer; transition: color 0.2s;
        }
        .age-stat-value:hover { color: #60a5fa; }
        
        .hotspot-footer { position: relative; padding-top: 1rem; margin-top: auto; border-top: 1px solid #1e293b; }
        .hotspot-actions {
            display: flex; flex-direction: row; justify-content: space-around;
            align-items: flex-start; gap: 1rem;
        }
        .hotspot-actions > div { flex: 1; text-align: center; }
        .hotspot-action-btn {
            background-color: rgba(30, 41, 59, 0.8); border: 1px solid #334155;
            color: #94a3b8; font-size: 0.8rem; font-weight: 600;
            padding: 0.5rem 1rem; border-radius: 99px; transition: all 0.3s; white-space: nowrap;
            width: 100%;
        }
        .hotspot-action-btn:hover:not(:disabled) { 
            background-color: #3b82f6; color: white; border-color: #3b82f6;
            transform: scale(1.05);
        }
        .hotspot-action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .hotspot-action-btn.is-clear {
            background: rgba(22, 163, 74, 0.1);
            border-color: #22c55e;
            color: #4ade80;
            box-shadow: 0 0 10px var(--glow-color-clear);
            cursor: default;
            opacity: 1;
        }
        .hotspot-action-btn.is-clear:hover:not(:disabled) {
            transform: none;
            background: rgba(22, 163, 74, 0.1);
            color: #4ade80;
        }
        .logic-details { font-size: 0.7rem; color: #64748b; text-align: center; margin-top: 4px; height: 1em; }

        /* Quick Stats section in card */
        .quick-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
            padding: 1rem 0;
            margin: 1rem 0;
            border-top: 1px solid #1e293b;
            border-bottom: 1px solid #1e293b;
        }
        .quick-stat-item .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f8fafc;
            line-height: 1;
        }
        .quick-stat-item .stat-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Per-card report button */
        .ntc-report-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: rgba(51, 65, 85, 0.5); /* slate-700/50 */
            color: #94a3b8; /* slate-400 */
            border-radius: 99px;
            padding: 0.5rem;
            transition: all 0.2s ease;
            z-index: 10;
        }
        .ntc-report-btn:hover {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            transform: scale(1.1);
        }

        /* --- Lite Mode Button --- */
        .lite-mode-btn {
            background-color: #334155;
            color: #e2e8f0;
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid #475569;
        }
        .lite-mode-btn.active {
            background-color: #16a34a; /* green-600 */
            color: white;
            border-color: #22c55e;
        }

        /* --- Modal & Table Styles --- */
        .modal-content { animation: fadeInUp 0.3s ease-out forwards; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #334155; }
        .report-textarea {
            width: 100%;
            height: 60vh;
            background-color: #0f172a;
            color: #e2e8f0;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: monospace;
        }
        
        /* --- Global & Mode-Specific Alerts --- */
        .mode-alert {
            background-color: rgba(15, 23, 42, 0.6); border-left: 5px solid; padding: 1.25rem;
            border-radius: 0.5rem; display: flex; gap: 1rem; align-items: flex-start; backdrop-filter: blur(5px);
        }
        .mode-alert .alert-icon { flex-shrink: 0; }
        .mode-alert.alert-insight { border-color: #3b82f6; }
        .mode-alert.alert-insight .alert-icon { color: #3b82f6; }
        .mode-alert .alert-title { font-weight: 700; font-size: 1.1rem; color: #f1f5f9; margin-bottom: 0.25rem; }
        .mode-alert .alert-message { color: #cbd5e1; line-height: 1.6; }

        .mode-selector {
            background-color: rgba(15, 23, 42, 0.5); border: 1px solid #1e293b;
            border-radius: 0.75rem; padding: 0.5rem; display: flex;
            width: fit-content; margin: 0 auto;
        }
        .mode-btn {
            border: 2px solid transparent; background-color: transparent; color: #94a3b8;
            padding: 0.75rem 2rem; border-radius: 0.5rem; font-weight: 700;
            font-size: 1.1rem; cursor: pointer; transition: all 0.2s ease-in-out; text-align: center;
        }
        .mode-btn .mode-subtitle { font-size: 0.8rem; font-weight: 400; color: #64748b; }
        .mode-btn.active {
            background-color: #3b82f6; color: white; box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        .mode-btn.active .mode-subtitle { color: #dbeafe; }

        /* --- Review Mode Specific Styles --- */
        .review-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        .review-card {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 1px solid #334155;
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .review-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            border-color: #3b82f6;
        }
        .review-card.is-complete {
            border-color: #22c55e;
            background: linear-gradient(145deg, #1e293b, #15803d20);
        }
        .review-card-header {
            text-align: center;
            border-bottom: 1px solid #334155;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .review-card-ntc {
            font-size: 2rem;
            font-weight: 800;
            color: #f1f5f9;
        }
        .review-card-count {
            font-size: 0.9rem;
            color: #94a3b8;
        }
        .review-card-body {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            flex-grow: 1;
        }
        .review-list-info {
            display: flex;
            justify-content: space-between;
            background-color: rgba(15, 23, 42, 0.5);
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        .review-list-info .label { color: #94a3b8; font-size: 0.9rem; }
        .review-list-info .value { color: #f1f5f9; font-weight: 700; font-size: 1.25rem; }
        .review-progress-container {
            margin-top: auto;
            padding-top: 1rem;
        }
        .review-progress-label {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
        }
        .review-progress-bar-bg {
            background-color: #334155;
            border-radius: 99px;
            height: 8px;
            overflow: hidden;
        }
        .review-progress-bar {
            background-color: #22c55e;
            height: 100%;
            width: 0%;
            border-radius: 99px;
            transition: width 0.5s ease;
        }
        .review-action-btn {
            background: linear-gradient(45deg, #1d4ed8, #2563eb);
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 0.5rem;
            margin-top: 1rem;
            transition: all 0.2s ease;
        }
        .review-action-btn:hover:not(:disabled) {
            transform: scale(1.03);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        .review-action-btn:disabled {
            background: #334155;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .review-card.is-complete .review-action-btn {
             background: linear-gradient(45deg, #16a34a, #22c55e);
        }

        .status-btn-group button {
            padding: 4px 10px; font-size: 12px; border: 1px solid #475569;
            transition: all 0.2s;
        }
        .status-btn-group button:first-child { border-top-left-radius: 6px; border-bottom-left-radius: 6px; }
        .status-btn-group button:last-child { border-top-right-radius: 6px; border-bottom-right-radius: 6px; }
        .status-btn-group button.active-connected { background-color: #22c55e; border-color: #22c55e; color: white; }
        .status-btn-group button.active-not-connected { background-color: #ef4444; border-color: #ef4444; color: white; }
        
        .remarks-container { margin-top: 8px; }
        .remarks-textarea {
            width: 100%; background-color: #1e293b; border: 1px solid #334155;
            border-radius: 6px; color: #cbd5e1; padding: 6px; font-size: 12px;
        }
        .remarks-tags { display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; }
        .remark-tag {
            background-color: #334155; color: #cbd5e1; font-size: 10px;
            padding: 2px 8px; border-radius: 99px; cursor: pointer; transition: background-color 0.2s;
        }
        .remark-tag:hover { background-color: #475569; }
        
        .report-filter-group {
            display: flex;
            background-color: #0f172a;
            border-radius: 0.5rem;
            padding: 0.25rem;
            margin-bottom: 1rem;
        }
        .report-filter-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            background-color: transparent;
            color: #94a3b8;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .report-filter-btn.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4);
        }

        /* Critical Summary Panel */
        .critical-summary-panel {
            background: rgba(15, 23, 42, 0.6); /* slate-900/60 */
            border: 1px solid #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
            border-radius: 1rem;
            backdrop-filter: blur(5px);
        }
        .critical-summary-panel .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            color: #f87171; /* red-400 */
            font-size: 1.25rem;
            font-weight: 700;
            padding: 1.5rem;
            cursor: pointer;
        }
         .critical-summary-panel .panel-header .toggle-icon {
            transition: transform 0.3s ease;
        }
        .critical-summary-panel .panel-header .toggle-icon.rotate-180 {
            transform: rotate(180deg);
        }
        .critical-summary-panel .panel-content {
            padding: 0 1.5rem 1.5rem 1.5rem;
            border-top: 1px solid #ef4444;
        }
        .critical-list-wrapper {
            transition: max-height 0.5s ease-in-out;
            overflow: hidden;
        }
        .critical-list-wrapper.collapsed {
            max-height: 280px; /* Approx 5 rows */
        }
        .critical-list-wrapper:not(.collapsed) {
            max-height: 400px; /* Expanded height */
            overflow-y: auto;
        }

        .critical-summary-panel .summary-table {
            width: 100%;
            border-collapse: collapse;
        }
        .critical-summary-panel .summary-table th, 
        .critical-summary-panel .summary-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #334155;
        }
        .critical-summary-panel .summary-table th {
            color: #94a3b8;
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        .critical-summary-panel .summary-table td {
            font-size: 0.9rem;
        }
        .critical-summary-panel .summary-table tbody tr:last-child td {
            border-bottom: none;
        }
        .critical-summary-panel .clickable-count {
            color: #f87171;
            text-decoration: underline;
            cursor: pointer;
        }
        .critical-summary-panel .clickable-count:hover {
            color: #ef4444;
        }
        .all-clear-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }
        .all-clear-message .status {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4ade80; /* green-400 */
            margin-top: 0.5rem;
        }
        .all-clear-message .detail {
            color: #94a3b8; /* slate-400 */
            margin-top: 0.25rem;
        }
        .critical-summary-panel .panel-footer {
            text-align: center;
            padding-top: 1rem;
            margin-top: 0.5rem;
        }
        .toggle-summary-btn {
            background-color: transparent;
            border: 1px solid #475569;
            color: #94a3b8;
            padding: 0.5rem 1.5rem;
            border-radius: 99px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .toggle-summary-btn:hover {
            background-color: #475569;
            color: white;
        }
        .update-log-link {
            text-decoration: underline;
            cursor: pointer;
            transition: color 0.2s;
        }
        .update-log-link:hover {
            color: #60a5fa;
        }
        .update-log-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        .update-log-content li {
            margin-bottom: 0.75rem;
        }

    </style>
</head>
<body class="text-slate-200">

<div class="main-container">
    <header class="text-center mb-12 flex justify-between items-center">
        <div id="top-left-actions" class="flex-1 text-left">
            <button id="lite-mode-toggle" class="lite-mode-btn">SLOW LOADING? SWITCH TO LITE MODE</button>
        </div>
        <div class="flex-grow">
            <h1 class="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-green-400 to-yellow-400">AGE-SIGHT</h1>
            <p class="mt-2 text-2xl text-slate-400 font-light tracking-widest">MISSION CONTROL</p>
        </div>
        <div id="top-right-actions" class="flex-1 flex flex-col gap-2 items-end"></div>
    </header>

    <div id="app-content">
        <div id="upload-view" class="max-w-2xl mx-auto text-center fade-in-up">
            <label for="csv-upload" id="upload-label" class="w-full cursor-pointer bg-slate-800/50 hover:bg-slate-700/70 border-2 border-dashed border-slate-600 rounded-lg flex flex-col items-center justify-center p-12 transition-all">
                <svg class="w-16 h-16 text-slate-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25h.375a9 9 0 019 9v.375M10.125 2.25A3.375 3.375 0 0113.5 5.625v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 013.375 3.375M9 15l2.25 2.25L15 12" /></svg>
                <span class="font-semibold text-2xl text-slate-200">Upload Operations File</span>
                <span id="file-name" class="text-base text-slate-400 mt-2">Drag & drop or click to select a .CSV file</span>
            </label>
            <input type="file" id="csv-upload" class="hidden" accept=".csv, text/csv">
            <div id="message-area" class="mt-6 text-center"></div>
        </div>

        <div id="live-mode-view" class="hidden space-y-8 fade-in-up">
            <div class="flex justify-center items-center gap-4">
                <div id="mode-selector" class="mode-selector">
                    <button id="mode-normal" class="mode-btn active">
                        <div>Normal Mode</div>
                        <div class="mode-subtitle">27h SLA (Buffer)</div>
                    </button>
                    <button id="mode-strict" class="mode-btn">
                        <div>Strict Mode</div>
                        <div class="mode-subtitle">24h SLA (No Buffer)</div>
                    </button>
                </div>
            </div>
            
            <div id="critical-summary-container"></div>

            <div class="flex justify-between items-center gap-4 flex-wrap">
                <button id="generate-live-report-btn" class="primary-btn" disabled>Generate Ageing Report</button>
                <div id="view-filters" class="flex gap-4 items-center flex-wrap">
                    <label class="flex items-center gap-2 cursor-pointer bg-slate-800/80 p-2 rounded-full text-sm">
                        <span>Include PST</span>
                        <div class="toggle-switch relative inline-block w-10 h-6">
                            <input type="checkbox" id="include-pst-toggle" class="opacity-0 w-0 h-0">
                            <span class="absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-slate-700 rounded-full transition-colors duration-300 before:absolute before:content-[''] before:h-4 before:w-4 before:left-1 before:bottom-1 before:bg-white before:rounded-full before:transition-transform before:duration-300"></span>
                        </div>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer bg-slate-800/80 p-2 rounded-full text-sm">
                        <span>Include Put Pending</span>
                        <div class="toggle-switch relative inline-block w-10 h-6">
                            <input type="checkbox" id="include-put-pending-toggle" class="opacity-0 w-0 h-0" checked>
                            <span class="absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-slate-700 rounded-full transition-colors duration-300 before:absolute before:content-[''] before:h-4 before:w-4 before:left-1 before:bottom-1 before:bg-white before:rounded-full before:transition-transform before:duration-300"></span>
                        </div>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer bg-slate-800/80 p-2 rounded-full text-sm">
                        <span>Urgent Only</span>
                        <div class="toggle-switch relative inline-block w-10 h-6">
                            <input type="checkbox" id="show-urgent-toggle" class="opacity-0 w-0 h-0" checked>
                            <span class="absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-slate-700 rounded-full transition-colors duration-300 before:absolute before:content-[''] before:h-4 before:w-4 before:left-1 before:bottom-1 before:bg-white before:rounded-full before:transition-transform before:duration-300"></span>
                        </div>
                    </label>
                </div>
            </div>
            <div id="summary-panel" class="hotspot-grid"></div>
        </div>

        <div id="review-mode-view" class="hidden space-y-8 fade-in-up">
            <div id="review-mode-alert"></div>
            <div id="review-cards-container" class="review-grid"></div>
            <div id="generate-report-container" class="text-center mt-8">
                 <button id="generate-report-btn" class="primary-btn" disabled>Generate PDF Report</button>
            </div>
        </div>
    </div>

    <footer class="text-center text-slate-500 mt-12 border-t border-slate-800 pt-6">
        AGE-SIGHT v2.8 | Designed by Rh. for âš¡ Team Sonic - Hubli | <span id="update-log-link" class="update-log-link">View Updates</span>
    </footer>
</div>

<div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
    <div class="modal-content bg-slate-900 p-6 rounded-lg shadow-2xl w-full max-w-7xl border border-slate-700 flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 id="detailsModalTitle" class="text-2xl font-bold text-white">Details</h3>
            <div id="modal-actions" class="flex items-center gap-4"></div>
        </div>
        <div id="detailsModalContent" class="scrollable-pane pr-2" style="max-height: 70vh; overflow-y: auto;"></div>
    </div>
</div>

<div id="updateLogModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
    <div class="modal-content bg-slate-900 p-6 rounded-lg shadow-2xl w-full max-w-2xl border border-slate-700 flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-white">Update Log</h3>
            <button id="closeUpdateLogModal" class="text-slate-400 hover:text-white"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        </div>
        <div class="update-log-content scrollable-pane pr-2 text-slate-300" style="max-height: 70vh; overflow-y: auto;">
            <ul>
                <li>
                    <strong>v2.8 (Latest)</strong>
                    <p class="text-sm text-slate-400">Added "Lite Mode" toggle to disable animations for performance. All data lists are now sorted by descending age (oldest first). Review Mode now separates B2B and B2C/Heavy items into distinct tables for clearer analysis.</p>
                </li>
                <li>
                    <strong>v2.7</strong>
                    <p class="text-sm text-slate-400">Major aesthetic and functional overhaul for Review Mode. Replaced the plain table with interactive cards featuring progress tracking. Ensured data filtering logic (PST/Client exceptions) is now consistent between Live and Review modes.</p>
                </li>
                <li>
                    <strong>v2.6</strong>
                    <p class="text-sm text-slate-400">Critical Ageing panel is now collapsible by default. Added this Update Log. Cleaned up UI elements.</p>
                </li>
                 <li>
                    <strong>v2.5</strong>
                    <p class="text-sm text-slate-400">Improved Critical Ageing panel to be more compact and intuitive, with clickable counts instead of action buttons.</p>
                </li>
                 <li>
                    <strong>v2.4</strong>
                    <p class="text-sm text-slate-400">Added advanced filtering (PST, Put Pending). Introduced separate reports for Internal, PST, and Not Put shipments.</p>
                </li>
                 <li>
                    <strong>v2.3</strong>
                    <p class="text-sm text-slate-400">Redesigned the top summary into a dedicated "Critical Ageing" panel with an expandable list.</p>
                </li>
                 <li>
                    <strong>v2.0</strong>
                    <p class="text-sm text-slate-400">Major redesign introducing Live Mode vs. Review Mode, dynamic hotspot cards, and automated ageing report generation.</p>
                </li>
            </ul>
        </div>
    </div>
</div>

<div id="accessKeyModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
    <div class="modal-content bg-slate-900 p-6 rounded-lg shadow-2xl w-full max-w-md border border-slate-700 flex flex-col">
        <h3 class="text-xl font-bold text-yellow-400 mb-2">Access Key Required</h3>
        <p class="text-sm text-slate-400 mb-4">Access restriction has been enabled on generating text reports due to misinformed and improper usage. Please enter the access key to proceed.</p>
        <input type="password" id="accessKeyInput" class="bg-slate-800 border border-slate-600 rounded-md p-2 w-full text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter access key...">
        <div id="accessKeyError" class="text-red-400 text-sm mt-2 h-5"></div>
        <div class="flex justify-end gap-4 mt-4">
            <button id="cancelAccessKey" class="secondary-action-btn" style="padding: 0.5rem 1rem;">Cancel</button>
            <button id="submitAccessKey" class="primary-btn">Submit</button>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    let originalFullData = [];
    let fullForecastData = [];
    let modalCurrentData = [];
    let hasPutawayLocation = false;
    let fileTimestamp = null;
    let currentMode = 'live'; // 'live' or 'review'
    let reviewDataStore = {}; // For review mode data
    let accessKeySuccessCallback = null;

    // --- DOM ELEMENT SELECTORS ---
    const uploadView = document.getElementById('upload-view');
    const liveModeView = document.getElementById('live-mode-view');
    const reviewModeView = document.getElementById('review-mode-view');
    const csvUpload = document.getElementById('csv-upload');
    const fileNameEl = document.getElementById('file-name');
    const messageArea = document.getElementById('message-area');
    const summaryPanel = document.getElementById('summary-panel');
    const detailsModal = document.getElementById('detailsModal');
    const detailsModalTitle = document.getElementById('detailsModalTitle');
    const detailsModalContent = document.getElementById('detailsModalContent');
    const modalActions = document.getElementById('modal-actions');
    const updateLogModal = document.getElementById('updateLogModal');
    const urgentToggleInput = document.getElementById('show-urgent-toggle');
    const pstToggleInput = document.getElementById('include-pst-toggle');
    const putPendingToggleInput = document.getElementById('include-put-pending-toggle');
    const modeSelector = document.getElementById('mode-selector');
    const generateReportBtn = document.getElementById('generate-report-btn');
    const generateLiveReportBtn = document.getElementById('generate-live-report-btn');
    const topRightActions = document.getElementById('top-right-actions');
    const liteModeToggle = document.getElementById('lite-mode-toggle');

    // --- LITE MODE FUNCTIONALITY ---
    function applyLiteModePreference() {
        const isLiteMode = localStorage.getItem('ageSightLiteMode') === 'true';
        if (isLiteMode) {
            document.body.classList.add('lite-mode-active');
            liteModeToggle.classList.add('active');
            liteModeToggle.textContent = 'Lite Mode: ON';
        } else {
            document.body.classList.remove('lite-mode-active');
            liteModeToggle.classList.remove('active');
            // MODIFIED: Changed default button text
            liteModeToggle.textContent = 'SLOW LOADING? SWITCH TO LITE MODE';
        }
    }

    liteModeToggle.addEventListener('click', () => {
        const isCurrentlyLite = document.body.classList.contains('lite-mode-active');
        localStorage.setItem('ageSightLiteMode', !isCurrentlyLite);
        applyLiteModePreference();
    });

    applyLiteModePreference(); // Apply on initial load

    // --- ACCESS KEY FUNCTIONALITY ---
    function promptForAccessKey(onSuccess) {
        accessKeySuccessCallback = onSuccess;
        const modal = document.getElementById('accessKeyModal');
        const input = document.getElementById('accessKeyInput');
        const errorEl = document.getElementById('accessKeyError');
        
        input.value = '';
        errorEl.textContent = '';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        input.focus();
    }

    function closeAccessKeyModal() {
        const modal = document.getElementById('accessKeyModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        accessKeySuccessCallback = null; // Clear the callback
    }
    
    document.getElementById('submitAccessKey').addEventListener('click', () => {
        const accessKey = atob('SEJM'); // 'HBL' in Base64
        const input = document.getElementById('accessKeyInput');
        const errorEl = document.getElementById('accessKeyError');
        
        if (input.value === accessKey) {
            if (accessKeySuccessCallback && typeof accessKeySuccessCallback === 'function') {
                accessKeySuccessCallback();
            }
            closeAccessKeyModal();
        } else {
            errorEl.textContent = 'Incorrect key. Please request access.';
            input.value = '';
            input.focus();
        }
    });

    document.getElementById('cancelAccessKey').addEventListener('click', closeAccessKeyModal);
    document.getElementById('accessKeyModal').addEventListener('click', (e) => {
        if (e.target.id === 'accessKeyModal') {
            closeAccessKeyModal();
        }
    });


    // --- INITIAL SETUP & EVENT LISTENERS ---

    function setupToggle(toggleInput, callback) {
        if (!toggleInput) return;
        toggleInput.addEventListener('change', () => {
            const slider = toggleInput.nextElementSibling;
            if (toggleInput.checked) {
                slider.classList.add('bg-blue-600');
                slider.classList.remove('bg-slate-700');
                slider.classList.add('before:translate-x-4');
            } else {
                slider.classList.remove('bg-blue-600');
                slider.classList.add('bg-slate-700');
                slider.classList.remove('before:translate-x-4');
            }
            if (callback) callback();
        });
        toggleInput.dispatchEvent(new Event('change'));
    }
    setupToggle(urgentToggleInput, renderSummaryPanel);
    setupToggle(pstToggleInput, renderSummaryPanel);
    setupToggle(putPendingToggleInput, renderSummaryPanel);

    modeSelector.addEventListener('click', (e) => {
        const targetBtn = e.target.closest('.mode-btn');
        if (!targetBtn || targetBtn.classList.contains('active')) return;
        modeSelector.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        targetBtn.classList.add('active');
        renderSummaryPanel();
    });

    csvUpload.addEventListener('change', (e) => handleFileUpload(e.target.files));

    document.getElementById('update-log-link').addEventListener('click', () => {
        updateLogModal.classList.remove('hidden');
        updateLogModal.classList.add('flex');
    });
     document.getElementById('closeUpdateLogModal').addEventListener('click', () => {
        updateLogModal.classList.add('hidden');
        updateLogModal.classList.remove('flex');
    });

    // --- REFACTORED EVENT LISTENERS ---
    
    liveModeView.addEventListener('click', e => {
        const ageValue = e.target.closest('.age-stat-value');
        if (ageValue) {
            const { ntc, bucket } = ageValue.dataset;
            let filtered = getCurrentlyVisibleData().filter(r => r.ntc === ntc && r.age_bucket === bucket);
            filtered.sort((a, b) => b.age_hours - a.age_hours); // Sort oldest first
            openDetailsModal(`Details for ${ntc} > ${bucket}`, filtered, false);
        }

        const cutoffBtn = e.target.closest('.hotspot-action-btn');
        if (cutoffBtn && !cutoffBtn.disabled) {
            const { ntc, pdt, cutoff } = cutoffBtn.dataset;
            if (!cutoff || cutoff === 'null') return; 
            let filteredData = getCurrentlyVisibleData().filter(r => r.ntc === ntc && pdt.split(',').includes(r.pdt) && r.age_hours >= parseFloat(cutoff));
            filteredData.sort((a, b) => b.age_hours - a.age_hours); // Sort oldest first
            openDetailsModal(`Recommended Ageing List for ${ntc} (${pdt})`, filteredData, true);
        }

        const clickableCount = e.target.closest('.clickable-count');
        if (clickableCount) {
            const { ntc, pdt, cutoff } = clickableCount.dataset;
            if (!cutoff || cutoff === 'null') return;
            let filteredData = getCurrentlyVisibleData().filter(r => r.ntc === ntc && pdt.split(',').includes(r.pdt) && r.age_hours >= parseFloat(cutoff));
            filteredData.sort((a, b) => b.age_hours - a.age_hours); // Sort oldest first
            openDetailsModal(`Recommended Ageing List for ${ntc} (${pdt})`, filteredData, true);
        }
        
        const generateBtn = e.target.closest('#generate-live-report-btn');
        if (generateBtn && !generateBtn.disabled) {
            promptForAccessKey(generateLiveReport);
        }
        
        const ntcReportBtn = e.target.closest('.ntc-report-btn');
        if (ntcReportBtn) {
            const { ntc } = ntcReportBtn.dataset;
            promptForAccessKey(() => generateNTCReport(ntc));
        }
        
        const summaryViewTarget = e.target.closest('.critical-summary-panel .clickable-count');
        if (summaryViewTarget) {
            const { ntc, pdt } = summaryViewTarget.dataset;
            const pdtLabel = pdt === 'b2c_heavy' ? 'B2C/Heavy' : 'B2B';
            let filtered = getCurrentlyVisibleData().filter(r => {
                const pdtGroup = (r.pdt === 'B2B') ? 'b2b' : 'b2c_heavy';
                return r.ntc === ntc && pdtGroup === pdt && r.age_hours >= 48;
            });
            filtered.sort((a, b) => b.age_hours - a.age_hours); // Sort oldest first
            openDetailsModal(`Critically Aged (>48h) for ${ntc} - ${pdtLabel}`, filtered, false);
        }
        
        const toggleBtn = e.target.closest('#toggle-critical-summary');
        if (toggleBtn) {
            const wrapper = document.getElementById('critical-list-wrapper');
            const isCollapsed = wrapper.classList.contains('collapsed');
            wrapper.classList.toggle('collapsed');
            if (isCollapsed) {
                toggleBtn.textContent = 'Show Less';
            } else {
                const totalRows = wrapper.querySelector('tbody').children.length;
                toggleBtn.textContent = `Show All (${totalRows})`;
            }
        }

        const panelHeader = e.target.closest('.panel-header');
        if (panelHeader && panelHeader.parentElement.classList.contains('critical-summary-panel')) {
            const content = panelHeader.nextElementSibling;
            const icon = panelHeader.querySelector('.toggle-icon');
            if (content) {
                content.classList.toggle('hidden');
                if (icon) icon.classList.toggle('rotate-180');
            }
        }
    });

    reviewModeView.addEventListener('click', e => {
        const reviewBtn = e.target.closest('.review-action-btn');
        if (reviewBtn) {
            const { ntc } = reviewBtn.dataset;
            const reviewData = JSON.parse(reviewBtn.dataset.reviewData);

            const b2cList = reviewData.b2c;
            const b2bList = reviewData.b2b;
            const allBagIds = [...b2cList, ...b2bList];

            let dataToReview = fullForecastData.filter(r => allBagIds.includes(r.bag_id));
            dataToReview.sort((a, b) => b.age_hours - a.age_hours); // Sort oldest first
            
            const modalTitle = `Reviewing Ageing List for ${ntc}`;
            openDetailsModal(modalTitle, dataToReview, false);
        }
    });
    
    detailsModal.addEventListener('click', e => {
        if (e.target === detailsModal) closeAllModals();

        const statusBtn = e.target.closest('.status-btn');
        if (statusBtn) handleStatusChange(statusBtn);

        const remarkTag = e.target.closest('.remark-tag');
        if (remarkTag) {
            const textarea = remarkTag.closest('.remarks-container').querySelector('textarea');
            const currentVal = textarea.value.trim();
            const tagText = `[${remarkTag.textContent}]`;
            textarea.value = currentVal ? `${currentVal} ${tagText}` : tagText;
            textarea.dispatchEvent(new Event('input', { bubbles: true })); // Ensure change is saved
        }

        const bulkSearchBtn = e.target.closest('#bulkSearchBtn');
        if (bulkSearchBtn) {
            document.getElementById('bulk-search-dropdown').classList.toggle('hidden');
        } else if (!e.target.closest('#bulk-search-menu')) {
            const dropdown = document.getElementById('bulk-search-dropdown');
            if (dropdown) dropdown.classList.add('hidden');
        }

        const modalActionBtn = e.target.closest('#modal-actions button');
        if(modalActionBtn) handleModalActions(modalActionBtn.id);
    });

    generateReportBtn.addEventListener('click', e => {
        if(!e.target.disabled) generatePDFReport();
    });

    topRightActions.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        let data;
        let title;

        switch(btn.id) {
            case 'internal-ageing-btn':
                data = originalFullData.filter(r => ['NORTH STORE', 'DELHIVERY'].includes(r.client.toUpperCase()) && r.age_hours >= 24);
                title = 'Internal Ageing Shipments (>24h)';
                break;
            case 'pst-ageing-btn':
                data = fullForecastData.filter(r => r.putaway_category === 'pst' && r.age_hours >= 24);
                title = 'PST Ageing Shipments (>24h)';
                break;
            case 'notput-ageing-btn':
                data = fullForecastData.filter(r => r.putaway_category === 'put_pending' && r.age_hours >= 24);
                title = 'Not Put Ageing Shipments (>24h)';
                break;
            default:
                return;
        }
        
        data.sort((a, b) => b.age_hours - a.age_hours); // Sort oldest first

        const groupedByNTC = data.reduce((acc, item) => {
            if (!acc[item.ntc]) acc[item.ntc] = [];
            acc[item.ntc].push(item.bag_id);
            return acc;
        }, {});
        
        const reportData = Object.keys(groupedByNTC).sort().map(ntc => ({
            ntc,
            list: groupedByNTC[ntc]
        }));

        openDetailsModal(title, reportData, false, 'simple-report');
    });

    // --- FILE PROCESSING & MODE SWITCHING ---
    function handleFileUpload(files) {
        const file = files[0];
        if (!file) return;
        fileTimestamp = new Date(file.lastModified);
        fileNameEl.textContent = file.name;
        const reader = new FileReader();
        reader.onload = (event) => processCsvData(event.target.result);
        reader.onerror = () => showMessage("Error reading file.", true);
        reader.readAsText(file);
    }

    function processCsvData(csvString) {
        showMessage('Processing...', false);
        try {
            const fileAgeMinutes = (new Date() - fileTimestamp) / 60000;
            currentMode = fileAgeMinutes > 30 ? 'review' : 'live';

            const lines = csvString.trim().split('\n');
            const headerLine = lines[0].trim();
            const rawHeaders = parseCsvLine(headerLine);
            const headers = rawHeaders.map(h => h.replace(/\s+/g, '_').toLowerCase());
            const requiredHeaders = ['bag_id', 'incoming_time', 'pdt', 'bag_status', 'is_lock', 'ntc_used'];
            if (!requiredHeaders.every(h => headers.includes(h))) {
                throw new Error(`Missing required columns: ${requiredHeaders.filter(h => !headers.includes(h)).join(', ')}`);
            }
            hasPutawayLocation = headers.includes('putaway_location');
            const data = lines.slice(1).map(line => {
                const values = parseCsvLine(line.trim());
                const obj = {};
                headers.forEach((header, i) => { obj[header] = values[i] || ''; });
                return obj;
            });

            const baseTime = currentMode === 'review' ? fileTimestamp : new Date();
            const enrichedData = analyzeAndEnrichData(data, baseTime);

            originalFullData = [...enrichedData];
            const internalClients = ['NORTH STORE', 'DELHIVERY'];
            fullForecastData = enrichedData.filter(row => !internalClients.includes(row.client.toUpperCase()));


            const summaryMessage = `<div class="text-left bg-slate-800/50 p-4 rounded-lg border border-slate-700 max-w-md mx-auto"><h4 class="font-bold text-lg text-blue-300 mb-2">File Scan Results:</h4><p>Total Records Found: <b class="text-white">${data.length}</b></p><p>External Shipments: <b class="text-green-400 text-xl">${fullForecastData.length}</b></p><p>Internal Shipments: <b class="text-yellow-400 text-lg">${originalFullData.length - fullForecastData.length}</b></p></div>`;
            showMessage(summaryMessage, false);

            setTimeout(() => {
                if (currentMode === 'live') {
                    setupLiveModeDashboard();
                } else {
                    setupReviewModeDashboard();
                }
            }, 1500);

        } catch (error) {
            showMessage(`An error occurred: ${error.message}`, true);
        }
    }
    
    function analyzeAndEnrichData(data, baseTime) {
        const now = new Date(baseTime);
        return data
            .filter(row => row.bag_status && row.is_lock && row.bag_status.toLowerCase() === 'in_center' && row.is_lock.toUpperCase() === 'FALSE')
            .map(row => {
                const incomingDate = new Date(row.incoming_time.replace(' ', 'T'));
                if (isNaN(incomingDate.getTime())) return null;
                const age_hours = Math.max(0, (now - incomingDate) / (1000 * 60 * 60));
                let age_bucket;
                if (age_hours < 24) age_bucket = '0 Day';
                else if (age_hours < 48) age_bucket = '1 Day';
                else if (age_hours < 96) age_bucket = '2-4 Days';
                else age_bucket = 'Above 4 Days';
                const ntcUsed = row.ntc_used || 'Unknown';
                const ntcSuggested = row.ntc_suggested_by_cluster || 'Unknown';

                let putaway_category = 'default';
                const location = row.putaway_location || '';
                if (!location) {
                    putaway_category = 'put_pending';
                } else if (location.toUpperCase().includes('PST')) {
                    putaway_category = 'pst';
                }

                return { 
                    ...row, 
                    age_hours: parseFloat(age_hours.toFixed(2)), 
                    age_bucket,
                    ntc: ntcUsed,
                    ntc_suggested: ntcSuggested,
                    ntc_mismatch: ntcUsed !== 'Unknown' && ntcSuggested !== 'Unknown' && ntcUsed !== ntcSuggested,
                    putaway_category
                };
            })
            .filter(Boolean);
    }
    
    // --- LIVE MODE FUNCTIONS ---
    function setupLiveModeDashboard() {
        uploadView.classList.add('hidden');
        reviewModeView.classList.add('hidden');
        liveModeView.classList.remove('hidden');
        topRightActions.innerHTML = `
            <button id="internal-ageing-btn" class="secondary-action-btn">Internal Ageing</button>
            <button id="pst-ageing-btn" class="secondary-action-btn">PST Ageing</button>
            <button id="notput-ageing-btn" class="secondary-action-btn">Not Put Ageing</button>
        `;
        renderSummaryPanel();
    }

    function calculateCutoff(shipments, forceNormal = false) {
        const now = currentMode === 'review' ? fileTimestamp : new Date();
        const relevantShipments = shipments.filter(r => r.etd && new Date(r.etd.replace(' ', 'T')) > now);
        if (relevantShipments.length === 0) return { cutoff: null, nextETD: null };
        const nextETD = new Date(Math.min(...relevantShipments.map(r => new Date(r.etd.replace(' ', 'T')))));
        const timeUntilNextETD_hours = (nextETD - now) / (1000 * 60 * 60);
        
        const isNormalMode = forceNormal || document.getElementById('mode-normal').classList.contains('active');
        const slaHours = isNormalMode ? 27 : 24;
        const cutoffForSLA = slaHours - timeUntilNextETD_hours;

        return {
            cutoff: cutoffForSLA > 0 ? cutoffForSLA.toFixed(1) : null,
            nextETD: nextETD
        };
    }

    // --- REVIEW MODE FUNCTIONS ---
    function setupReviewModeDashboard() {
        uploadView.classList.add('hidden');
        liveModeView.classList.add('hidden');
        reviewModeView.classList.remove('hidden');
        reviewDataStore = {};
        topRightActions.innerHTML = '';

        document.getElementById('review-mode-alert').innerHTML = `
            <div class="mode-alert alert-insight">
                <div class="alert-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z" clip-rule="evenodd" /></svg></div>
                <div>
                    <div class="alert-title">REVIEW MODE ACTIVATED</div>
                    <p class="alert-message">File is older than 30 minutes. Time is frozen to <b>${fileTimestamp.toLocaleString()}</b>. Data excludes PST and Not Put shipments. All lists are based on Normal Mode (27h SLA).</p>
                </div>
            </div>`;
        
        // **LOGIC CORRECTION**: Ensure review mode uses the same default filters as live mode.
        const dataToReview = fullForecastData.filter(r => r.putaway_category !== 'pst' && r.putaway_category !== 'put_pending');
        const summary = getSummaryData(dataToReview);
        
        summary.sort((a, b) => {
            if (a.data.soonestETD === null && b.data.soonestETD === null) return 0;
            if (a.data.soonestETD === null) return 1;
            if (b.data.soonestETD === null) return -1;
            return a.data.soonestETD - b.data.soonestETD;
        });

        const container = document.getElementById('review-cards-container');
        if (summary.length > 0) {
            container.innerHTML = summary.map(item => {
                const { ntc, data, b2c_heavy_recommendation, b2b_recommendation } = item;

                const b2cCutoff = b2c_heavy_recommendation.cutoff;
                const b2cList = b2cCutoff ? dataToReview.filter(r => r.ntc === ntc && r.pdt !== 'B2B' && r.age_hours >= parseFloat(b2cCutoff)).map(r => r.bag_id) : [];

                const b2bCutoff = b2b_recommendation.cutoff;
                const b2bList = b2bCutoff ? dataToReview.filter(r => r.ntc === ntc && r.pdt === 'B2B' && r.age_hours >= parseFloat(b2bCutoff)).map(r => r.bag_id) : [];

                const totalInReview = b2cList.length + b2bList.length;
                if (totalInReview === 0) return ''; // Don't render a card if there's nothing to review

                const reviewData = { b2c: b2cList, b2b: b2bList };
                
                return `
                    <div class="review-card" id="review-card-${ntc}" data-ntc="${ntc}" data-total-review-items="${totalInReview}">
                        <div class="review-card-header">
                            <div class="review-card-ntc">${ntc}</div>
                            <div class="review-card-count">${data.total} Total Shipments</div>
                        </div>
                        <div class="review-card-body">
                           <div class="review-list-info">
                                <div class="text-center">
                                    <div class="label">B2C/Heavy List</div>
                                    <div class="value">${b2cList.length}</div>
                                </div>
                                <div class="text-center">
                                    <div class="label">B2B List</div>
                                    <div class="value">${b2bList.length}</div>
                                </div>
                           </div>
                           <div class="review-progress-container">
                                <div class="review-progress-label">
                                    <span>Review Progress</span>
                                    <span id="progress-text-${ntc}">0 / ${totalInReview}</span>
                                </div>
                                <div class="review-progress-bar-bg">
                                    <div class="review-progress-bar" id="progress-bar-${ntc}"></div>
                                </div>
                           </div>
                        </div>
                        <button class="review-action-btn" data-ntc="${ntc}" data-review-data='${JSON.stringify(reviewData)}' ${totalInReview === 0 ? 'disabled' : ''}>
                            ${totalInReview > 0 ? 'Start Review' : 'No Items to Review'}
                        </button>
                    </div>
                `;
            }).join('');
        } else {
            container.innerHTML = `<div class="col-span-full text-center bg-slate-800/50 p-8 rounded-lg border border-slate-700"><h3 class="font-bold text-2xl text-yellow-400 mb-2">No Data for Review</h3><p class="text-slate-400">The uploaded file does not contain any actionable shipments to review based on its timestamp.</p></div>`;
            generateReportBtn.disabled = true;
        }
    }

    function handleStatusChange(button) {
        const bagId = button.closest('tr').dataset.bagId;
        const group = button.closest('.status-btn-group');
        const remarksContainer = button.closest('tr').querySelector('.remarks-container');
        const newStatus = button.dataset.status;

        group.querySelectorAll('button').forEach(btn => btn.classList.remove('active-connected', 'active-not-connected'));
        
        if (newStatus === 'Connected') {
            button.classList.add('active-connected');
            remarksContainer.innerHTML = ''; // Clear remarks area
            reviewDataStore[bagId] = { status: 'Connected', remarks: '' };
        } else {
            button.classList.add('active-not-connected');
            remarksContainer.innerHTML = `
                <textarea class="remarks-textarea" placeholder="Enter remarks..."></textarea>
                <div class="remarks-tags">
                    <span class="remark-tag">Ops Failure</span>
                    <span class="remark-tag">Missing</span>
                    <span class="remark-tag">Uncontrollable</span>
                    <span class="remark-tag">System Issue</span>
                </div>
            `;
            reviewDataStore[bagId] = { status: 'Not Connected', remarks: '' };
            remarksContainer.querySelector('textarea').addEventListener('input', e => {
                reviewDataStore[bagId].remarks = e.target.value;
            });
        }
        
        const ntc = modalCurrentData[0]?.ntc;
        if(ntc) updateReviewCardProgress(ntc);
    }
    
    function updateReviewCardProgress(ntc) {
        const card = document.getElementById(`review-card-${ntc}`);
        if (!card) return;

        const totalItems = parseInt(card.dataset.totalReviewItems, 10);
        const reviewData = JSON.parse(card.querySelector('.review-action-btn').dataset.reviewData);
        const allBagIds = [...reviewData.b2c, ...reviewData.b2b];

        const reviewedCount = allBagIds.filter(bagId => reviewDataStore[bagId]?.status).length;
        
        const progressPercent = totalItems > 0 ? (reviewedCount / totalItems) * 100 : 0;
        
        document.getElementById(`progress-bar-${ntc}`).style.width = `${progressPercent}%`;
        document.getElementById(`progress-text-${ntc}`).textContent = `${reviewedCount} / ${totalItems}`;

        if (reviewedCount === totalItems) {
            card.classList.add('is-complete');
            card.querySelector('.review-action-btn').textContent = 'Review Complete';
        }
        
        // Check if all reviews are complete to enable the report button
        const allCards = document.querySelectorAll('.review-card');
        const allComplete = [...allCards].every(c => c.classList.contains('is-complete'));
        generateReportBtn.disabled = !allComplete;
    }
    
    // --- MODAL & DYNAMIC CONTENT FUNCTIONS ---
    function openDetailsModal(title, data, isSuggestion, viewType = 'default') {
        modalCurrentData = data;
        detailsModalTitle.textContent = title;
        if (currentMode === 'live') {
            if (viewType === 'simple-report') {
                renderSimpleReportModal(data);
            } else if (viewType === 'ntc-report' || title === 'Live Ageing Report') {
                renderLiveReportModal(data);
            } else {
                renderTable(data, detailsModalContent, isSuggestion);
                updateBulkSearchLinks(data);
            }
        } else { // Review Mode
            renderGroupedReviewTables(data);
            updateBulkSearchLinks(data);
        }
        detailsModal.classList.remove('hidden');
        detailsModal.classList.add('flex');
    }

    function handleModalActions(actionId) {
        switch(actionId) {
            case 'closeDetailsModal': closeAllModals(); break;
            case 'copyReportBtn': 
                promptForAccessKey(() => {
                    const reportText = document.getElementById('report-textarea').value;
                    const btn = document.getElementById('copyReportBtn');
                    navigator.clipboard.writeText(reportText).then(() => {
                        const originalText = btn.textContent;
                        btn.textContent = 'Copied!';
                        setTimeout(() => { btn.textContent = originalText; }, 2000);
                    }).catch(err => console.error('Failed to copy report:', err));
                });
                break;
            case 'recommendPickSpacesBtn': showPickSpaces(); break;
            case 'backToDetailsBtn': renderTable(modalCurrentData, null, true); break;
            case 'copyLocationsBtn': copyPickLocations(target); break;
            case 'mark-all-connected':
                modalCurrentData.forEach(item => {
                    const btn = document.querySelector(`tr[data-bag-id="${item.bag_id}"] .status-btn[data-status="Connected"]`);
                    if(btn && !btn.classList.contains('active-connected')) handleStatusChange(btn);
                });
                break;
            case 'mark-all-not-connected':
                 modalCurrentData.forEach(item => {
                    const btn = document.querySelector(`tr[data-bag-id="${item.bag_id}"] .status-btn[data-status="Not Connected"]`);
                    if(btn && !btn.classList.contains('active-not-connected')) handleStatusChange(btn);
                });
                break;
        }
    }
    
    function renderGroupedReviewTables(data) {
        setupReviewModalActions();
        if (data.length === 0) {
            detailsModalContent.innerHTML = `<p class="text-slate-400 p-8 text-center">No shipments match.</p>`;
            return;
        }

        const b2cData = data.filter(item => item.pdt !== 'B2B');
        const b2bData = data.filter(item => item.pdt === 'B2B');
        
        let finalHTML = '';

        if (b2cData.length > 0) {
            finalHTML += `<h4 class="text-xl font-bold text-blue-300 mb-2 mt-4">B2C / Heavy List (${b2cData.length})</h4>`;
            finalHTML += generateReviewTableHTML(b2cData);
        }

        if (b2bData.length > 0) {
            finalHTML += `<h4 class="text-xl font-bold text-yellow-300 mb-2 mt-6">B2B List (${b2bData.length})</h4>`;
            finalHTML += generateReviewTableHTML(b2bData);
        }
        
        detailsModalContent.innerHTML = finalHTML;

        // Re-attach listeners for textareas
        detailsModalContent.querySelectorAll('.remarks-textarea').forEach(textarea => {
            textarea.addEventListener('input', e => {
                const bagId = e.target.closest('tr').dataset.bagId;
                if(reviewDataStore[bagId]) {
                    reviewDataStore[bagId].remarks = e.target.value;
                }
            });
        });
    }

    function generateReviewTableHTML(data) {
        data.forEach(item => {
            if (!reviewDataStore[item.bag_id]) {
                reviewDataStore[item.bag_id] = { status: null, remarks: '' };
            }
        });

        return `
            <table class="data-table">
                <thead><tr>
                    <th>Bag ID</th><th>Age (Hrs)</th><th>NTC</th><th>Client</th><th>Status & Remarks</th>
                </tr></thead>
                <tbody>
                ${data.map(wbn => {
                    const storedState = reviewDataStore[wbn.bag_id] || {};
                    const isConnected = storedState.status === 'Connected';
                    const isNotConnected = storedState.status === 'Not Connected';
                    return `
                    <tr data-bag-id="${wbn.bag_id}">
                        <td><a href="${getBagIdLink(wbn.bag_id)}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">${wbn.bag_id}</a></td>
                        <td>${wbn.age_hours}</td>
                        <td>${wbn.ntc}</td>
                        <td class="truncate" title="${wbn.client}">${wbn.client}</td>
                        <td>
                            <div class="status-btn-group" role="group">
                                <button type="button" class="status-btn ${isConnected ? 'active-connected' : ''}" data-status="Connected">Connected</button>
                                <button type="button" class="status-btn ${isNotConnected ? 'active-not-connected' : ''}" data-status="Not Connected">Not Connected</button>
                            </div>
                            <div class="remarks-container">
                            ${isNotConnected ? `
                                <textarea class="remarks-textarea" placeholder="Enter remarks...">${storedState.remarks || ''}</textarea>
                                <div class="remarks-tags">
                                    <span class="remark-tag">Ops Failure</span>
                                    <span class="remark-tag">Missing</span>
                                    <span class="remark-tag">Uncontrollable</span>
                                    <span class="remark-tag">System Issue</span>
                                </div>
                            ` : ''}
                            </div>
                        </td>
                    </tr>
                `}).join('')}
                </tbody>
            </table>
        `;
    }
    
    // --- REPORTING FUNCTIONS ---
    function generateNTCReport(ntc) {
        const dataToUse = getCurrentlyVisibleData();
        const summaryData = getSummaryData(dataToUse);
        const ntcItem = summaryData.find(item => item.ntc === ntc);
        if (!ntcItem) return;

        const { b2c_heavy_recommendation, b2b_recommendation } = ntcItem;
        const b2cCutoff = b2c_heavy_recommendation.cutoff;
        const b2bCutoff = b2b_recommendation.cutoff;
        
        let b2cList = [];
        if (b2cCutoff) {
            b2cList = dataToUse
                .filter(r => r.ntc === ntc && r.pdt !== 'B2B' && r.age_hours >= parseFloat(b2cCutoff))
                .sort((a, b) => b.age_hours - a.age_hours) // Sort oldest first
                .map(item => item.bag_id);
        }

        let b2bList = [];
        if (b2bCutoff) {
            b2bList = dataToUse
                .filter(r => r.ntc === ntc && r.pdt === 'B2B' && r.age_hours >= parseFloat(b2bCutoff))
                .sort((a, b) => b.age_hours - a.age_hours) // Sort oldest first
                .map(item => item.bag_id);
        }
        
        const reportDataForNTC = [{ ntc, b2cList, b2bList }];
        openDetailsModal(`Live Ageing Report for ${ntc}`, reportDataForNTC, false, 'ntc-report');
    }
            
    function generateLiveReport() {
        const dataToUse = getCurrentlyVisibleData();
        const summaryData = getSummaryData(dataToUse);
        summaryData.sort((a, b) => {
            if (a.data.soonestETD === null && b.data.soonestETD === null) return 0;
            if (a.data.soonestETD === null) return 1;
            if (b.data.soonestETD === null) return -1;
            return a.data.soonestETD - b.data.soonestETD;
        });

        const reportData = summaryData.map(ntcItem => {
            const { ntc, b2c_heavy_recommendation, b2b_recommendation } = ntcItem;
            
            const b2cCutoff = b2c_heavy_recommendation.cutoff;
            const b2bCutoff = b2b_recommendation.cutoff;
            
            let b2cList = [];
            if (b2cCutoff) {
                b2cList = dataToUse
                    .filter(r => r.ntc === ntc && r.pdt !== 'B2B' && r.age_hours >= parseFloat(b2cCutoff))
                    .sort((a, b) => b.age_hours - a.age_hours) // Sort oldest first
                    .map(item => item.bag_id);
            }

            let b2bList = [];
            if (b2bCutoff) {
                b2bList = dataToUse
                    .filter(r => r.ntc === ntc && r.pdt === 'B2B' && r.age_hours >= parseFloat(b2bCutoff))
                    .sort((a, b) => b.age_hours - a.age_hours) // Sort oldest first
                    .map(item => item.bag_id);
            }
            
            if (b2cList.length > 0 || b2bList.length > 0) {
                 return { ntc, b2cList, b2bList };
            }
            return null;
        }).filter(Boolean);
        
        openDetailsModal("Live Ageing Report", reportData, false);
    }
    
    function formatReportText(reportData, filter) {
        const reportParts = [];
        reportData.forEach(ntcItem => {
            const { ntc, b2cList, b2bList } = ntcItem;
            let ntcBlockParts = [ntc];
            let hasContent = false;

            if ((filter === 'all' || filter === 'b2c') && b2cList.length > 0) {
                ntcBlockParts.push("\nB2C/Heavy");
                ntcBlockParts.push(...b2cList);
                hasContent = true;
            }

            if ((filter === 'all' || filter === 'b2b') && b2bList.length > 0) {
                ntcBlockParts.push("\nB2B");
                ntcBlockParts.push(...b2bList);
                hasContent = true;
            }
            
            if (hasContent) {
                reportParts.push(ntcBlockParts.join("\n"));
            }
        });
        return reportParts.join("\n\n");
    }

    function formatSimpleReportText(reportData) {
        return reportData.map(item => {
            return `${item.ntc}\n${item.list.join('\n')}`;
        }).join('\n\n');
    }

    function renderSimpleReportModal(reportData) {
        modalActions.innerHTML = `
            <button id="copyReportBtn" class="primary-btn">Copy Report</button>
            <button id="closeDetailsModal" class="text-slate-400 hover:text-white ml-4"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        `;
        detailsModalContent.innerHTML = `<textarea id="report-textarea" readonly class="report-textarea"></textarea>`;
        document.getElementById('report-textarea').value = formatSimpleReportText(reportData);
    }

    function renderLiveReportModal(reportData) {
        modalActions.innerHTML = `
            <button id="copyReportBtn" class="primary-btn">Copy Report</button>
            <button id="closeDetailsModal" class="text-slate-400 hover:text-white ml-4"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        `;

        detailsModalContent.innerHTML = `
            <div id="report-filter-group" class="report-filter-group">
                <button class="report-filter-btn active" data-filter="all">All</button>
                <button class="report-filter-btn" data-filter="b2c">B2C/Heavy</button>
                <button class="report-filter-btn" data-filter="b2b">B2B</button>
            </div>
            <textarea id="report-textarea" readonly class="report-textarea"></textarea>
        `;

        const reportTextarea = document.getElementById('report-textarea');
        const filterGroup = document.getElementById('report-filter-group');

        const updateReportView = (filter) => {
            reportTextarea.value = formatReportText(reportData, filter);
        };
        
        filterGroup.addEventListener('click', e => {
            const btn = e.target.closest('.report-filter-btn');
            if (btn) {
                filterGroup.querySelectorAll('.report-filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                updateReportView(btn.dataset.filter);
            }
        });

        // Initial render
        updateReportView('all');
    }


    function setupReviewModalActions() {
        let buttonsHTML = `
            <button id="mark-all-connected" class="secondary-action-btn">Mark All Connected</button>
            <button id="mark-all-not-connected" class="secondary-action-btn">Mark All Not Connected</button>
            <div class="relative" id="bulk-search-menu">
                 <button id="bulkSearchBtn" class="primary-btn flex items-center gap-2">
                     <span>Bulk Search in HQ</span>
                     <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                 </button>
                 <div id="bulk-search-dropdown" class="hidden absolute right-0 mt-2 w-64 rounded-md shadow-lg bg-slate-800 ring-1 ring-black ring-opacity-5 z-10">
                     <div class="py-1">
                         <a href="#" id="bulkSearchBagsLink" target="_blank" rel="noopener noreferrer" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700"></a>
                         <a href="#" id="bulkSearchShipmentsLink" target="_blank" rel="noopener noreferrer" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700"></a>
                     </div>
                 </div>
            </div>
            <button id="closeDetailsModal" class="text-slate-400 hover:text-white ml-4"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        `;
        modalActions.innerHTML = buttonsHTML;
    }
    
    function generatePDFReport() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const reviewedNTCs = [...new Set(Object.values(reviewDataStore)
            .map(review => fullForecastData.find(d => d.bag_id === Object.keys(reviewDataStore).find(key => reviewDataStore[key] === review)))
            .filter(Boolean)
            .map(item => item.ntc)
        )].sort();

        let finalY = 20;

        doc.setFontSize(18);
        doc.text("AGE-SIGHT Connection Review Report", 105, finalY, { align: 'center' });
        finalY += 8;
        doc.setFontSize(10);
        doc.text(`Report Generated: ${new Date().toLocaleString()}`, 105, finalY, { align: 'center' });
        finalY += 4;
        doc.text(`Data Timestamp: ${fileTimestamp.toLocaleString()}`, 105, finalY, { align: 'center' });
        finalY += 10;


        reviewedNTCs.forEach(ntc => {
            let ntcData = Object.entries(reviewDataStore)
                .map(([bagId, review]) => {
                    const itemData = fullForecastData.find(d => d.bag_id === bagId);
                    if (itemData && itemData.ntc === ntc) {
                        return { ...itemData, ...review };
                    }
                    return null;
                }).filter(item => item && item.status); // Only include items that have been reviewed
            
            if (ntcData.length === 0) return;

            // Sort oldest first for the PDF report
            ntcData.sort((a, b) => b.age_hours - a.age_hours);

            doc.setFontSize(14);
            doc.text(`Review for NTC: ${ntc}`, 14, finalY);
            finalY += 8;

            const tableColumn = ["Bag ID", "Age (Hrs)", "Client", "Status", "Remarks"];
            const tableRows = [];

            ntcData.forEach(item => {
                const rowData = [
                    item.bag_id,
                    item.age_hours,
                    item.client,
                    item.status,
                    item.remarks
                ];
                tableRows.push(rowData);
            });
            
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: finalY,
                theme: 'grid',
                headStyles: { fillColor: [30, 41, 59] },
                didDrawPage: function (data) {
                    finalY = data.cursor.y;
                }
            });
            finalY = doc.previousAutoTable.finalY + 10;
        });

        doc.save(`AGE-SIGHT_Review_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    // --- UTILITY FUNCTIONS ---
    function parseCsvLine(line) {
        const results = [];
        const regex = /(?:^|,)(\"(?:[^\"]+|\"\")*\"|[^,]*)/g;
        let match;
        while (match = regex.exec(line)) {
            let value = match[1];
            if (value.startsWith('"') && value.endsWith('"')) {
                value = value.slice(1, -1).replace(/""/g, '"');
            }
            results.push(value.trim());
        }
        return results;
    }
    
    // --- SHARED & REFACTORED FUNCTIONS ---
    
    function getCurrentlyVisibleData() {
        if (!fullForecastData) return [];
        let data = fullForecastData;
        if (!pstToggleInput.checked) {
            data = data.filter(r => r.putaway_category !== 'pst');
        }
        if (!putPendingToggleInput.checked) {
            data = data.filter(r => r.putaway_category !== 'put_pending');
        }
        return data;
    }

    function getSummaryData(data) {
        const dataToSummarize = data || getCurrentlyVisibleData();
        if (!dataToSummarize) return [];
        const baseTime = currentMode === 'review' ? fileTimestamp : new Date();

        const summary = dataToSummarize.reduce((acc, row) => {
            const { ntc, pdt, etd } = row;
            if (!acc[ntc]) {
                acc[ntc] = { total: 0, b2c_heavy: { '0 Day': 0, '1 Day': 0, '2-4 Days': 0, 'Above 4 Days': 0, total: 0 }, b2b: { '0 Day': 0, '1 Day': 0, '2-4 Days': 0, 'Above 4 Days': 0, total: 0 }, soonestETD: null };
            }
            const pdtGroup = (pdt === 'B2B') ? 'b2b' : 'b2c_heavy';
            acc[ntc][pdtGroup][row.age_bucket]++;
            acc[ntc][pdtGroup].total++;
            acc[ntc].total++;
            if (etd) {
                const etdDate = new Date(etd.replace(' ', 'T'));
                if (!isNaN(etdDate) && etdDate > baseTime && (!acc[ntc].soonestETD || etdDate < acc[ntc].soonestETD)) {
                    acc[ntc].soonestETD = etdDate;
                }
            }
            return acc;
        }, {});

        return Object.entries(summary).map(([ntc, data]) => {
            const ntcShipments = dataToSummarize.filter(r => r.ntc === ntc);
            const b2cHeavyShipments = ntcShipments.filter(r => r.pdt !== 'B2B');
            const b2bShipments = ntcShipments.filter(r => r.pdt === 'B2B');
            const severeCount = data.b2c_heavy['2-4 Days'] + data.b2c_heavy['Above 4 Days'] + data.b2b['2-4 Days'] + data.b2b['Above 4 Days'];
            const severityScore = (data.b2c_heavy['1 Day'] + data.b2b['1 Day']) * 1 + (data.b2c_heavy['2-4 Days'] + data.b2b['2-4 Days']) * 3 + (data.b2c_heavy['Above 4 Days'] + data.b2b['Above 4 Days']) * 5;
            let severityLevel = 'low';
            if (severityScore > data.total * 0.5) severityLevel = 'medium';
            if (severityScore > data.total) severityLevel = 'high';
            if (severeCount > 20 && (severeCount / data.total) > 0.3) severityLevel = 'critical';
            return { ntc, data, severityScore, severityLevel, b2c_heavy_recommendation: calculateCutoff(b2cHeavyShipments, true), b2b_recommendation: calculateCutoff(b2bShipments, true) };
        });
    }

    function getCountdownString(etdDate, baseTime) {
        const now = baseTime ? new Date(baseTime) : new Date();
        const diff = new Date(etdDate) - now;
        if (diff <= 0) return 'Departed';
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        return `${String(hours).padStart(2,'0')}h ${String(minutes).padStart(2,'0')}m`;
    }

    function getBagIdLink(bagId) {
        const cleanedId = (bagId || '').replace(/[^a-zA-Z0-9]/g, '');
        if (!cleanedId) return '#';
        const isNumeric = /^\d+$/.test(cleanedId);
        return isNumeric ? `https://hq.delhivery.com/p/pntrzz/${cleanedId}/` : `https://hq.delhivery.com/bag/${cleanedId}/`;
    }

    function renderTable(data, container, isSuggestion) { // This is for LIVE mode
        setupModalActions('table', isSuggestion);
        if (data.length === 0) {
            detailsModalContent.innerHTML = `<p class="text-slate-400 p-8 text-center">No shipments match.</p>`;
            return;
        }
        const table = document.createElement('table');
        table.className = 'data-table';
        table.innerHTML = `
            <thead><tr>
                <th>Bag ID</th><th>Age (Hrs)</th>${hasPutawayLocation ? '<th>Location</th>' : ''}<th>PDT</th><th>Priority</th><th>NTC</th><th>Client</th>
            </tr></thead>
            <tbody>
            ${data.map(wbn => `
                <tr>
                    <td><a href="${getBagIdLink(wbn.bag_id)}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">${wbn.bag_id}</a></td>
                    <td class="${wbn.age_hours >= 48 ? 'text-red-400 font-bold' : ''}">${wbn.age_hours}</td>
                    ${hasPutawayLocation ? `<td>${wbn.putaway_location || 'N/A'}</td>` : ''}
                    <td>${wbn.pdt}</td>
                    <td>${wbn.priority}</td>
                    <td>${wbn.ntc}${wbn.ntc_mismatch ? `<span class="ntc-suggestion-glow" title="Suggested: ${wbn.ntc_suggested}">*${wbn.ntc_suggested}</span>` : ''}</td>
                    <td class="truncate" title="${wbn.client}">${wbn.client}</td>
                </tr>
            `).join('')}
            </tbody>`;
        detailsModalContent.innerHTML = '';
        detailsModalContent.appendChild(table);
    }
    
    function updateBulkSearchLinks(data) {
        const bags = [];
        const shipments = [];
        data.forEach(item => {
            const cleanedId = (item.bag_id || '').replace(/[^a-zA-Z0-9]/g, '');
            if (!cleanedId) return;
            /^\d+$/.test(cleanedId) ? shipments.push(cleanedId) : bags.push(cleanedId);
        });
        const bagsLink = document.getElementById('bulkSearchBagsLink');
        const shipmentsLink = document.getElementById('bulkSearchShipmentsLink');
        if (bagsLink && shipmentsLink) {
            bagsLink.href = bags.length > 0 ? `https://hq.delhivery.com/bag/list/1?bs=${bags.join('+')}` : '#';
            bagsLink.classList.toggle('opacity-50', bags.length === 0);
            bagsLink.classList.toggle('cursor-not-allowed', bags.length === 0);
            bagsLink.textContent = `Bulk Search Bags (${bags.length})`;
            shipmentsLink.href = shipments.length > 0 ? `https://hq.delhivery.com/p/list/1?type=waybill&q=${shipments.join('%20')}` : '#';
            shipmentsLink.classList.toggle('opacity-50', shipments.length === 0);
            shipmentsLink.classList.toggle('cursor-not-allowed', shipments.length === 0);
            shipmentsLink.textContent = `Bulk Search Shipments (${shipments.length})`;
        }
    }

    function showPickSpaces() {
        const locations = [...new Set(modalCurrentData.map(item => item.putaway_location).filter(Boolean))];
        setupModalActions('locations');
        if (locations.length === 0) {
            detailsModalContent.innerHTML = `<p class="text-slate-400 p-8 text-center">No putaway locations found.</p>`;
            return;
        }
        detailsModalContent.innerHTML = `<div class="flex flex-wrap gap-3 p-4">${locations.sort().map(loc => `<span class="bg-slate-700 text-slate-200 font-mono text-lg py-2 px-4 rounded-md">${loc}</span>`).join('')}</div>`;
    }

    function setupModalActions(view, isSuggestion = false) { // This is for LIVE mode
        let buttonsHTML = '';
        if (view === 'table') {
            buttonsHTML += `
            <div class="relative" id="bulk-search-menu">
                <button id="bulkSearchBtn" class="primary-btn flex items-center gap-2">
                    <span>Bulk Search in HQ</span>
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="bulk-search-dropdown" class="hidden absolute right-0 mt-2 w-64 rounded-md shadow-lg bg-slate-800 ring-1 ring-black ring-opacity-5 z-10">
                    <div class="py-1">
                        <a href="#" id="bulkSearchBagsLink" target="_blank" rel="noopener noreferrer" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700"></a>
                        <a href="#" id="bulkSearchShipmentsLink" target="_blank" rel="noopener noreferrer" class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700"></a>
                    </div>
                </div>
            </div>`;
            if (isSuggestion && hasPutawayLocation) {
                buttonsHTML += `<button id="recommendPickSpacesBtn" class="primary-btn" style="background: linear-gradient(45deg, #f59e0b, #facc15);">Recommend Pick Spaces</button>`;
            }
        } else if (view === 'locations') {
            buttonsHTML += `<button id="backToDetailsBtn" class="secondary-btn">Back to Details</button><button id="copyLocationsBtn" class="primary-btn">Copy Locations</button>`;
        }
        buttonsHTML += `<button id="closeDetailsModal" class="text-slate-400 hover:text-white ml-4"><svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
        modalActions.innerHTML = buttonsHTML;
    }

    function closeAllModals() {
        detailsModal.classList.add('hidden');
        detailsModal.classList.remove('flex');
        updateLogModal.classList.add('hidden');
        updateLogModal.classList.remove('flex');
        modalCurrentData = [];
    }
    
    function copyPickLocations(button) {
        const locations = [...detailsModalContent.querySelectorAll('span')].map(span => span.textContent.trim());
        if (locations.length > 0) {
            navigator.clipboard.writeText(locations.join('\n')).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => { button.textContent = originalText; }, 2000);
            });
        }
    }

    function showMessage(msg, isError) {
        messageArea.innerHTML = msg;
        messageArea.className = isError 
            ? `mt-4 text-center p-3 rounded-md text-red-200 bg-red-900/40` 
            : `mt-4 text-center`;
    }

    function renderSummaryPanel() {
        // This entire function is part of LIVE MODE
        if (!fullForecastData) return;
        
        const dataToUse = getCurrentlyVisibleData();
        const summaryPanel = document.getElementById('summary-panel');
        generateLiveReportBtn.disabled = dataToUse.length === 0;

        if (dataToUse.length === 0) {
            summaryPanel.innerHTML = `<div class="col-span-full text-center bg-slate-800/50 p-8 rounded-lg border border-slate-700"><h3 class="font-bold text-2xl text-yellow-400 mb-2">No Actionable Data Found</h3><p class="text-slate-400">The uploaded file does not contain any shipments matching the current filter criteria.</p></div>`;
            renderCriticalSummary(); // Still render this to show the "All Clear" message if applicable
            return;
        }

        const showUrgentOnly = document.getElementById('show-urgent-toggle').checked;
        let summaryData = getSummaryData(dataToUse);
        
        renderCriticalSummary();

        if (showUrgentOnly) {
            const fiveHoursFromNow = new Date().getTime() + (5 * 60 * 60 * 1000);
            summaryData = summaryData.filter(item => item.data.soonestETD && item.data.soonestETD.getTime() < fiveHoursFromNow);
        }
        
        summaryData.sort((a, b) => {
            const aETD = a.data.soonestETD;
            const bETD = b.data.soonestETD;
            if (aETD === null && bETD === null) return b.severityScore - a.severityScore;
            if (aETD === null) return 1;
            if (bETD === null) return -1;
            if (aETD.getTime() !== bETD.getTime()) {
                return aETD - bETD;
            }
            return b.severityScore - a.severityScore;
        });
        
        if (summaryData.length === 0) {
            summaryPanel.innerHTML = `<p class="text-slate-400 text-center col-span-full">No NTCs match the current "Urgent Only" view.</p>`;
            return;
        }
        summaryPanel.innerHTML = summaryData.map(({ ntc, data, severityLevel, b2c_heavy_recommendation, b2b_recommendation }) => {
            const ageBuckets = ['0 Day', '1 Day', '2-4 Days', 'Above 4 Days'];
            const totalAgeData = ageBuckets.map(bucket => ({
                label: bucket,
                count: (data.b2c_heavy[bucket] || 0) + (data.b2b[bucket] || 0)
            }));
            const etdString = data.soonestETD ? `ETD in ${getCountdownString(data.soonestETD)}` : 'No Upcoming ETD';
            
            const b2cCutoff = b2c_heavy_recommendation.cutoff;
            const b2bCutoff = b2b_recommendation.cutoff;
            
            let alertHTML = '';
            let b2cCount = 0;
            if (b2cCutoff) {
                b2cCount = dataToUse.filter(r => r.ntc === ntc && r.pdt !== 'B2B' && r.age_hours >= parseFloat(b2cCutoff)).length;
            }
            let b2bCount = 0;
            if (b2bCutoff) {
                b2bCount = dataToUse.filter(r => r.ntc === ntc && r.pdt === 'B2B' && r.age_hours >= parseFloat(b2bCutoff)).length;
            }

            if (b2cCount > 0 || b2bCount > 0) {
                 alertHTML = `
                    <div class="card-alert">
                        <div class="card-alert-title">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15h14a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM8 16a2 2 0 114 0H8z" clip-rule="evenodd" /></svg>
                            <span>Action Required</span>
                        </div>
                        <p class="card-alert-message">
                            Prioritize picking 
                            ${b2cCount > 0 ? `<span class="clickable-count" data-ntc="${ntc}" data-pdt="B2C,Heavy" data-cutoff="${b2cCutoff}">${b2cCount}</span> B2C/Heavy` : ''}
                            ${b2cCount > 0 && b2bCount > 0 ? ' & ' : ''}
                            ${b2bCount > 0 ? `<span class="clickable-count" data-ntc="${ntc}" data-pdt="B2B" data-cutoff="${b2bCutoff}">${b2bCount}</span> B2B` : ''}
                            shipments.
                        </p>
                    </div>`;
            }

            const ntcShipments = dataToUse.filter(r => r.ntc === ntc);
            const maxAge = ntcShipments.length > 0 ? Math.max(...ntcShipments.map(r => r.age_hours)) : 0;

            return `
                <div class="hotspot-card-v2 severity-${severityLevel}">
                    <button class="ntc-report-btn" data-ntc="${ntc}" title="Generate report for ${ntc}">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"></path></svg>
                    </button>
                    <div class="hotspot-header">
                        <div class="hotspot-ntc">${ntc}</div>
                        <div class="hotspot-total-count">${data.total} Shipments</div>
                        <div class="hotspot-etd-display">${etdString}</div>
                    </div>

                    <div class="quick-stats">
                        <div class="quick-stat-item">
                            <div class="stat-value">${data.b2c_heavy.total}</div>
                            <div class="stat-label">B2C/Heavy</div>
                        </div>
                        <div class="quick-stat-item">
                            <div class="stat-value">${data.b2b.total}</div>
                            <div class="stat-label">B2B</div>
                        </div>
                        <div class="quick-stat-item">
                            <div class="stat-value">${maxAge.toFixed(1)}h</div>
                            <div class="stat-label">Max Age</div>
                        </div>
                    </div>
                    
                    ${alertHTML}

                    <div class="age-stats-container">
                        ${totalAgeData.map(age => `
                            <div class="age-stat">
                                <span class="age-stat-label">${age.label}</span>
                                <span class="age-stat-value" data-ntc="${ntc}" data-bucket="${age.label}">${age.count}</span>
                            </div>`).join('')}
                    </div>
                    
                    <div class="hotspot-footer">
                        <div class="hotspot-actions">
                             <div>
                                <button class="hotspot-action-btn ${b2cCount === 0 ? 'is-clear' : ''}" data-ntc="${ntc}" data-pdt="B2C,Heavy" data-cutoff="${b2cCutoff}" ${b2cCount === 0 ? 'disabled' : ''}>
                                    ${b2cCount > 0 ? `B2C/H List (${b2cCount})` : 'B2C/H Clear'}
                                </button>
                                <div class="logic-details">
                                    ${b2cCutoff ? `Cut-off: ${b2cCutoff}h` : (b2cCount === 0 ? `<span class="text-green-400">No Ageing!</span>` : '')}
                                </div>
                            </div>
                            <div>
                                <button class="hotspot-action-btn ${b2bCount === 0 ? 'is-clear' : ''}" data-ntc="${ntc}" data-pdt="B2B" data-cutoff="${b2bCutoff}" ${b2bCount === 0 ? 'disabled' : ''}>
                                    ${b2bCount > 0 ? `B2B List (${b2bCount})` : 'B2B Clear'}
                                </button>
                                <div class="logic-details">
                                    ${b2bCutoff ? `Cut-off: ${b2bCutoff}h` : (b2bCount === 0 ? `<span class="text-green-400">No Ageing!</span>` : '')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }).join('');
    }
    
    function renderCriticalSummary() {
        // This function is for LIVE MODE
        const container = document.getElementById('critical-summary-container');
        const dataToUse = getCurrentlyVisibleData();
        
        const criticalShipments = dataToUse.filter(r => r.age_hours >= 48);

        if (criticalShipments.length === 0) {
            container.innerHTML = `
                <div class="critical-summary-panel" style="border-color: #22c55e; box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);">
                    <div class="all-clear-message">
                        <svg class="w-16 h-16 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="status">SYSTEMS NOMINAL</span>
                        <span class="detail">No shipments currently over 48 hours.</span>
                    </div>
                </div>`;
            return;
        }

        const summary = criticalShipments.reduce((acc, row) => {
            const pdtGroup = (row.pdt === 'B2B') ? 'b2b' : 'b2c_heavy';
            if (!acc[row.ntc]) {
                acc[row.ntc] = { b2b: 0, b2c_heavy: 0 };
            }
            acc[row.ntc][pdtGroup]++;
            return acc;
        }, {});
        
        const summaryList = Object.entries(summary).map(([ntc, counts]) => ({
            ntc,
            b2bCount: counts.b2b,
            b2cCount: counts.b2c_heavy,
            totalCount: counts.b2b + counts.b2c_heavy
        }));

        summaryList.sort((a, b) => b.totalCount - a.totalCount);

        const tableRowsHTML = summaryList.map(item => `
            <tr>
                <td>${item.ntc}</td>
                <td class="font-bold text-red-400 text-center">
                    ${item.b2bCount > 0 ? `<span class="clickable-count" data-ntc="${item.ntc}" data-pdt="b2b">${item.b2bCount}</span>` : '0'}
                </td>
                <td class="font-bold text-red-400 text-center">
                    ${item.b2cCount > 0 ? `<span class="clickable-count" data-ntc="${item.ntc}" data-pdt="b2c_heavy">${item.b2cCount}</span>` : '0'}
                </td>
            </tr>
        `).join('');
        
        const rowCount = summaryList.length;
        const isCollapsible = rowCount > 5;

        let panelHTML = `
            <div id="critical-summary-panel" class="critical-summary-panel">
                <div class="panel-header">
                    <div class="flex items-center gap-3">
                        <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                        </svg>
                        <span>CRITICAL AGEING (>48 HRS)</span>
                    </div>
                    <svg class="w-6 h-6 toggle-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                </div>
                <div class="panel-content hidden">
                    <div id="critical-list-wrapper" class="${isCollapsible ? 'collapsed' : ''}">
                        <table class="summary-table">
                            <thead>
                                <tr><th>NTC</th><th class="text-center">B2B Count</th><th class="text-center">B2C/Heavy Count</th></tr>
                            </thead>
                            <tbody>
                                ${tableRowsHTML}
                            </tbody>
                        </table>
                    </div>
                    ${isCollapsible ? `
                    <div class="panel-footer">
                        <button id="toggle-critical-summary" class="toggle-summary-btn">Show All (${rowCount})</button>
                    </div>
                    ` : ''}
                </div>
            </div>`;
        container.innerHTML = panelHTML;
    }

});
</script>

</body>
</html>
